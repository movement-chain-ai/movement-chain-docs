# 三个反馈通道

> **文档目的**: 定义系统向用户传递反馈的通道类型、延迟预算和各模式的反馈策略
>
> **适用范围**: 所有训练模式（评估、练习、引导、实战）

---

## 1. 概述

反馈系统是连接"分析结果"和"用户感知"的桥梁。不同的反馈通道有不同的特性，适用于不同的场景。

```text
┌─────────────────────────────────────────────────────────────────────────────┐
│                         反馈系统架构                                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  分析结果                    反馈通道                     用户感知              │
│  ────────                  ────────                    ────────             │
│                                                                             │
│  ┌─────────────┐          ┌─────────────┐          ┌─────────────┐          │
│  │ 问题检测     │          │ 语音反馈      │          │ 听觉        │          │
│  │ 指标计算     │  ─────▶  │ 视觉反馈      │  ─────▶  │ 视觉        │          │
│  │ 规则判断     │          │ 触觉反馈      │          │ 触觉        │          │
│  └─────────────┘          └─────────────┘          └─────────────┘          │
│                                                                             │
│  ────────────────────────────────────────────────────────────────────────── │
│                                                                             │
│  延迟预算: 从检测到问题 → 用户感知到反馈 的总时间                                  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. 反馈通道

### 2.1 通道对比

| 反馈通道 | 延迟 | 信息量 | 适用场景 | 优势 | 局限 |
|---------|------|-------|---------|------|------|
| **语音反馈** | 50-100ms | 高 | 所有场景 | 信息量大，无需看屏幕 | 需要安静环境 |
| **视觉反馈** | <20ms | 高 | 所有场景 | 精确展示位置/角度 | 用户需看屏幕 |
| **触觉反馈** | <50ms | 低 | 挥杆过程 | 唯一能实时干预的方式 | 信息量有限 |

### 2.2 语音反馈

语音反馈是信息量最大的通道，分为两种实现方式：

#### 预录制语音文件

适用于固定的、高频使用的反馈内容。优点是延迟低、音质好。

| 类别 | 文件名 | 文案 | 时长 |
|-----|-------|------|------|
| **核心问题 (P0)** | `core_first.mp3` | "从核心启动" | ~1s |
| | `engage_core.mp3` | "收紧腹部发力" | ~1.2s |
| | `sequence_wrong.mp3` | "发力顺序错了" | ~1s |
| **旋转问题 (P1)** | `more_rotation.mp3` | "肩膀再多转一点" | ~1.2s |
| | `hip_lead.mp3` | "髋部先转开" | ~1s |
| **节奏问题 (P1)** | `slow_backswing.mp3` | "上杆慢一点" | ~1s |
| | `faster_downswing.mp3` | "下杆再快一点" | ~1s |
| | `good_tempo.mp3` | "节奏不错" | ~0.8s |
| **站姿问题** | `shoulders_tense.mp3` | "肩膀有些紧张" | ~1s |
| | `stance_narrow.mp3` | "站距偏窄" | ~0.8s |
| | `knees_straight.mp3` | "膝盖较直" | ~0.8s |
| **正面反馈** | `good_swing.mp3` | "这一杆不错" | ~1s |
| | `great_power.mp3` | "力量很好" | ~0.8s |
| | `perfect.mp3` | "完美！" | ~0.6s |

#### TTS 动态生成

适用于需要包含具体数据的反馈（如角度、速度）：

```swift
import AVFoundation  // iOS 原生 TTS

class FeedbackSpeaker {
    private let synthesizer = AVSpeechSynthesizer()

    /// 动态生成语音反馈
    /// - Examples:
    ///   - generateFeedback("X因子\(xFactor)度，不够")
    ///   - generateFeedback("速度\(speed)，很不错")
    func generateFeedback(_ text: String, rate: Float = 0.5) {
        let utterance = AVSpeechUtterance(string: text)
        utterance.voice = AVSpeechSynthesisVoice(language: "zh-CN")
        utterance.rate = rate
        synthesizer.speak(utterance)
    }
}
```

### 2.3 视觉反馈

视觉反馈延迟最低，适用于精确展示位置和角度信息。

#### 2.3.1 评估报告 UI

评估完成后生成的可视化报告界面：

| 组件 | 说明 | 内容示例 |
|-----|------|---------|
| **问题卡片** | 每个问题独立卡片展示 | 问题描述 + 严重程度 + 改进建议 |
| **视频回放** | 带标注的关键片段回放 | 问题时刻 + 姿态骨架 + 角度标注 |
| **数据图表** | sEMG / IMU 数据可视化 | 肌肉激活时序图、关节角度曲线 |
| **热力图** | 肌肉激活强度分布 | 颜色渐变表示激活程度 |
| **对比视图** | 用户动作 vs 标准动作 | 分屏或叠加对比 |
| **评分概览** | 整体评估得分 | 各维度评分 + 综合得分 |

#### 2.3.2 用户视频

采集用户视频, 并在视频上叠加以下信息（实时或回放）：

| 类型 | 说明 | 适用场景 |
|-----|------|---------|
| **姿态骨架** | 关节点 + 连接线（火柴人风格） | 实时预览、回放分析 |
| **角度标注** | 角度弧线 + 数值显示 | 评估报告、回放分析 |
| **轨迹绘制** | 绘制运动轨迹曲线 | 挥杆路径分析 |
| **问题高亮** | 红色高亮问题区域 | 问题定位 |
| **进度指示** | 显示阶段进度条 | 引导模式 |
| **阶段标记** | 动作阶段文字标注 | 回放分析 |

> **开发调试工具**：开发阶段可使用 [Rerun SDK](https://rerun.io/) 进行视频叠加调试和姿态分析可视化。Rerun 支持 MediaPipe 姿态点的 2D/3D 可视化，适合快速验证算法效果。生产环境使用原生方案（iOS: Core Graphics / Metal）。

**sEMG 肌肉激活可视化**：

我们采集了真实的 sEMG 肌肉数据，可在视频上叠加肌肉发力信息的方案考虑如下（不叠加解剖模型）：

| 形式 | 说明 | 适用场景 |
|-----|------|---------|
| **颜色圆点/光晕** | 在肌肉位置叠加颜色圆点，冷→暖表示激活强度 | 实时预览、回放分析 |
| **数值标签** | 显示激活百分比（如 "背阔肌 85%"） | 回放分析 |
| **脉冲动画** | 发力瞬间在对应位置显示脉冲光环 | 关键发力点强调 |
| **边缘进度条** | 视频边缘显示各肌群激活进度条 | 实时预览（不遮挡主体） |

> **推荐组合**：实时/回放使用「颜色圆点 + 数值标签」；评估报告使用「身体轮廓热力图 + 时序曲线图」。

#### 2.3.3 教学视频

预制的动作演示视频，帮助用户理解正确动作：

| 类型 | 说明 | 适用场景 |
|-----|------|---------|
| **Drill 示范** | 展示正确的 Drill 动作 | 练习模式、引导模式 |
| **动作对比** | 正确 vs 错误动作对比 | 练习模式、引导模式 |
| **要点讲解** | 关键动作点的暂停标注 | 练习模式、引导模式 |

### 2.4 触觉反馈

触觉反馈 (<50ms 延迟) 是唯一能在挥杆过程中实时干预的方式。

#### 硬件依赖

触觉反馈需要**振动输出设备**：

| 设备 | 说明 | 优劣 |
|-----|------|------|
| **Apple Watch** | 通过 WatchKit 触发振动 | ✅ 贴近身体，感知明确；❌ 需额外开发 watchOS App |
| **iPhone Taptic Engine** | 通过 Core Haptics 控制 | ⚠️ 用户打球时不握手机，实用性有限 |
| **自定义可穿戴输出设备** | 手环/腰带上的振动马达 | ✅ 位置灵活；❌ 需要硬件开发 |

!!! note "MVP 不包含触觉反馈"
    触觉反馈需要额外硬件支持，列入 Post-MVP 阶段。

#### 振动模式

| 模式 | 振动时长 | 含义 | 触发条件 |
|-----|---------|-----|---------|
| 短振 (50ms) | 1次 | 轻微提示 | 接近阈值边界 |
| 短振 (50ms) | 2次 | 需要注意 | 超出阈值 |
| 长振 (200ms) | 1次 | 严重问题 | 严重超出阈值 |
| 连续振 | 持续 | 停止动作 | 危险动作 |

#### 触觉反馈场景

| 场景 | 触发条件 | 振动模式 |
|-----|---------|---------|
| 上杆过快 | 上杆时间 < 500ms | 短振 2次 |
| 上杆顶点不够 | X-Factor < 20° | 短振 1次 |
| 下杆过早释放 | 手腕角度过早变化 | 短振 2次 |
| 疲劳预警 | EMG 激活强度下降 30% | 长振 1次 |

---

## 3. 延迟预算

### 3.1 端到端延迟分解

```text
┌─────────────────────────────────────────────────────────────────────────────┐
│                    END-TO-END LATENCY BREAKDOWN                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  传感器采集         特征提取          规则判断          反馈生成                  │
│  ────────────     ───────────      ──────────       ──────────              │
│                                                                             │
│  Vision: 33ms     骨骼提取: 20ms    规则匹配: <5ms    语音播放: ~100ms         │
│  (30fps)          (MediaPipe)                       (预加载音频)              │
│                                                                             │
│  IMU: <10ms       姿态估算: 5ms                      视觉渲染: <20ms           │
│  (100Hz)          (Madgwick)                        (Metal)                 │
│                                                                             │
│  EMG: <5ms        时间同步: <5ms                    触觉振动: <10ms            │
│                                                                             │
│  ────────────────────────────────────────────────────────────────────────── │
│                                                                             │
│  延迟预算:    33 + 30 + 5 + 100 = ~170ms                                     │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 各场景延迟要求

| 模式 | 场景 | 延迟要求 | 主要瓶颈 | 原因 | 优化策略 |
|-----|------|---------|---------|------|---------|
| **评估模式** | 步骤语音指令 | <500ms | TTS 生成 | "请站好"、"请慢速挥杆"等指令 | 预录制音频 |
| **评估模式** | 评估报告 | 无实时要求 | 无 | 挥杆结束后分析，无延迟约束 | - |
| **练习模式** | Drill 指导 | <1s | TTS 生成 | 用户在动作间隙接收指导，容忍度较高 | 预缓存常用语音 |
| **练习模式** | 动作计数 | <500ms | 音频播放 | "第3组，第5次" | 预录制音频 |
| **引导模式** | 站姿引导 | <300ms | TTS 生成 | 用户静止等待，语音是主要反馈方式 | 预缓存常用语音 |
| **引导模式** | 挥杆引导 | <500ms | Vision 帧率 | 需要追踪连续动作，30fps 每帧 33ms | 提高到 60fps |
| **实战模式** | 击球后反馈 | <100ms | 触觉响应 | 击球后快速反馈，不干扰下一杆 | 触觉优先 |
| **练习/引导/实战** | 触觉干预 | <50ms | 硬件响应 | 挥杆过程中干预，要求极低延迟 | 本地处理，无网络 |

### 3.3 优化策略

| 策略 | 适用场景 | 效果 |
|-----|---------|------|
| **预加载音频** | 语音反馈 | 消除 TTS 生成延迟 |
| **本地推理** | 所有实时场景 | 避免网络延迟 |
| **60fps 采集** | 快速动作追踪 | 减少帧间误差累积 |
| **优先级队列** | 多反馈冲突 | 确保高优先级反馈先触达 |

---

## 4. 各模式反馈策略

### 4.1 反馈策略矩阵

| 模式 | 语音反馈 | 视觉反馈 | 触觉反馈 | 时机 |
|-----|---------|---------|---------|------|
| **评估模式** | ✅ 步骤指令 + 报告讲解 | ✅ 视频回放 + 标注 | ❌ | 流程中 + 事后 |
| **练习模式** | ✅ Drill 指导 + 计数 | ✅ 动作演示 | ✅ 可选 | 练习中 |
| **引导模式** | ✅ 实时提示 | ✅ 实时叠加 | ✅ 可选 | 动作中 |
| **实战模式** | ⚠️ 简短 | ⚠️ 最小化 | ✅ 主要 | 动作中 |

### 4.2 评估模式反馈

评估模式的反馈分为**流程中指令**和**事后报告**两部分：

#### 流程中指令（实时）

评估三步流程中需要语音引导用户：

| 步骤 | 语音指令示例 | 延迟要求 |
|-----|-------------|---------|
| 站姿检测 | "请站好，保持放松" | <500ms |
| 慢速挥杆 | "请慢速挥杆，我来分析动作" | <500ms |
| 全力挥杆 | "请全力挥杆" | <500ms |

#### 事后报告（无实时要求）

- **视频回放 + 问题标注**：在视频上标记问题时刻
- **语音讲解**：TTS 生成问题解释和改进建议
- **数据可视化**：图表展示指标对比

详见 [评估模式](modes/assessment-mode.md)

### 4.3 练习模式反馈

练习模式的反馈是**Drill 过程中的指导**：

| 反馈类型 | 内容 | 延迟要求 |
|---------|------|---------|
| **动作演示** | 展示正确的 Drill 动作 | 预加载 |
| **语音指导** | Drill 执行要点提示 | <1s |
| **动作计数** | "第3组，第5次" | <500ms |
| **触觉干预** | 动作过程中的实时纠正 | <50ms |
| **完成确认** | Drill 完成后的正向反馈 | <1s |

!!! note "触觉反馈为可选"
    练习模式的触觉反馈需要 Apple Watch 或自定义可穿戴设备，列入 Post-MVP。

详见 [练习模式](modes/drill-mode.md)

### 4.4 引导模式反馈

引导模式需要**实时反馈**，对延迟要求最高：

| 引导类型 | 语音反馈 | 视觉反馈 | 触觉反馈 |
|---------|---------|---------|---------|
| **站姿引导** | ✅ 主要 | ✅ 辅助 | ❌ 不适用 |
| **挥杆引导** | ✅ 主要 | ✅ 辅助 | ✅ 可选 |

详见 [引导模式](modes/guide-mode.md)

### 4.5 实战模式反馈

实战模式的反馈需要**最小化干扰**：

- **触觉优先**：不打断用户注意力
- **语音简短**：只在击球后简短反馈
- **视觉最小化**：不遮挡视线

详见 [实战模式](modes/game-mode.md)

---

## 5. 反馈冲突处理

当多个反馈同时触发时，需要优先级管理：

### 5.1 优先级规则

| 优先级 | 反馈类型 | 示例 |
|-------|---------|------|
| P0 | 安全相关 | "动作有受伤风险" |
| P1 | 核心问题 | "发力顺序错误" |
| P2 | 次要问题 | "站距偏窄" |
| P3 | 正面反馈 | "这一杆不错" |

### 5.2 冲突处理

```python
class FeedbackManager:
    """
    反馈管理器

    处理多反馈冲突，确保用户不被信息轰炸
    """

    def __init__(self, cooldown_ms=2000):
        self.cooldown = cooldown_ms
        self.last_feedback_time = {}
        self.pending_feedbacks = []

    def add_feedback(self, feedback_type, priority, content):
        """添加待发送的反馈"""
        self.pending_feedbacks.append({
            'type': feedback_type,
            'priority': priority,
            'content': content,
            'timestamp': time.time()
        })

    def get_next_feedback(self):
        """获取下一个应该发送的反馈"""
        if not self.pending_feedbacks:
            return None

        # 按优先级排序
        self.pending_feedbacks.sort(key=lambda x: x['priority'])

        # 检查冷却时间
        feedback = self.pending_feedbacks[0]
        feedback_type = feedback['type']
        last_time = self.last_feedback_time.get(feedback_type, 0)

        if time.time() - last_time > self.cooldown / 1000:
            self.pending_feedbacks.pop(0)
            self.last_feedback_time[feedback_type] = time.time()
            return feedback

        return None
```

---

## 6. 实施路线图

| 阶段 | 内容 | 优先级 | 说明 |
|------|------|--------|------|
| **MVP** | 评估报告视觉反馈 | 🔴 必须 | 问题卡片、数据图表 |
| **Post-MVP** | 预录制语音文件 | 🔴 必须 | 基础反馈语音库 |
| **Post-MVP** | 视频回放 + 语音讲解 | 🔴 必须 | 评估报告核心体验 |
| **Post-MVP** | 实时语音引导 | 🟡 高 | 引导模式核心功能 |
| **Post-MVP** | TTS 动态生成 | 🟡 中 | 个性化数据反馈 |
| **Post-MVP** | 触觉振动反馈 | 🟡 中 | 需要 Apple Watch 联动 |

---

## 7. 相关文档

| 相关文档 | 内容 | 本文档使用 |
|---------|------|-----------|
| [评估模式](modes/assessment-mode.md) | 事后报告反馈 | 报告生成策略 |
| [练习模式](modes/drill-mode.md) | Drill 指导反馈 | 练习过程反馈 |
| [引导模式](modes/guide-mode.md) | 实时引导反馈 | 延迟要求来源 |
| [实战模式](modes/game-mode.md) | 最小化干扰反馈 | 触觉优先策略 |

---

**最后更新**: 2026-01-08
**维护者**: Movement Chain AI Team
