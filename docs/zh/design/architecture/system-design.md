# 系统设计 System Design

> **文档角色**: 总纲 (Hub) - 系统核心设计文档，所有详细规格文档的入口
>
> **目标读者**: 技术负责人、新加入的团队成员、投资者
>
> **阅读时间**: 15分钟

---

## 1. 产品愿景与最终目标

### 1.1 产品愿景

**一句话**: 基于 Vision + IMU + EMG 三模态融合的高尔夫挥杆分析系统，通过 AI 教练提供可执行的改进建议。

**核心差异化**: EMG 肌肉激活检测 — 竞品只能告诉你"什么错了"，我们能告诉你"为什么错了"。

### 1.2 系统架构图 {#12-完整系统架构}

```text
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                     Movement Chain AI — 完整产品数据流                                │
│                     (端到端产品工作原理: 从挥杆到反馈)                                   │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                     │
│  ╔═══════════════════════════════════════════════════════════════════════════════╗  │
│  ║  STAGE 1: 用户挥杆 (User Swings)                                               ║  │
│  ║                                                                               ║  │
│  ║                        🏌️ 高尔夫球手挥杆                                        ║  │
│  ║                             │                                                 ║  │
│  ║      ┌──────────────────────┼──────────────────────┐                          ║  │
│  ║      │                      │                      │                          ║  │
│  ║      ▼                      ▼                      ▼                          ║  │
│  ║ 📹 iPhone Camera       💪 Wearable Sensors    💪 Wearable Sensors             ║  │
│  ║  (Vision 30fps)         (Arm Hub)             (Core Hub)                      ║  │
│  ╚═══════════════════════════════════════════════════════════════════════════════╝  │
│                                       │                                             │
│  ╔═══════════════════════════════════════════════════════════════════════════════╗  │
│  ║  STAGE 2: 数据采集层 (Data Collection)                                          ║  │
│  ║                                                                                ║  │
│  ║  ┌─────────────────┐     ┌─────────────────────┐    ┌─────────────────────┐    ║  │
│  ║  │  📹 Vision       │    │  🔄 Arm Hub         │    │  🔄 Core Hub        │    ║  │
│  ║  │  ─────────────   │    │  ─────────────────  │    │  ─────────────────  │    ║  │
│  ║  │  • iPhone Camera │    │  • ESP32-S3         │    │  • ESP32-S3         │    ║  │
│  ║  │  • MediaPipe iOS │    │  • LSM6DSV16X (IMU) │    │  • LSM6DSV16X (IMU) │    ║  │
│  ║  │  • 33 keypoints  │    │  • MyoWare 2.0 (EMG)│    │  • MyoWare 2.0 (EMG)│    ║  │
│  ║  │  • 30 fps        │    │  • 共享时钟源         │    │  • 共享时钟源         │   ║  │
│  ║  └────────┬─────────┘    └─────────┬───────────┘    └─────────┬───────────┘    ║  │
│  ║           │                        │                          │                ║  │
│  ║           │                        └───────────┬──────────────┘                ║  │
│  ║           │                                    │                               ║  │
│  ║           │ Native SDK                         │ BLE 5.0                       ║  │
│  ║           │ (No latency)                       │ (源端时间戳，消除抖动)            ║  │
│  ║           │                                    │                               ║  │
│  ║           └──────────────────┬─────────────────┘                               ║  │
│  ║                              ▼                                                 ║  │
│  ║                    ┌─────────────────────┐                                     ║  │
│  ║                    │  📱 Swift iOS App    │                                    ║  │
│  ║                    │  • MediaPipeTasksVision                                   ║  │
│  ║                    │  • CoreBluetooth                                          ║  │
│  ║                    │  • 数据接收与缓存                                            ║  │
│  ║                    └─────────┬───────────┘                                     ║  │
│  ║                                                                                ║  │
│  ║  【空间姿态 WHAT】       【运动时序 WHEN】         【肌肉激活 WHY】                  ║  │
│  ╚══════════════════════════════│════════════════════════════════════════════════╝  │
│                                 │                                                   │
│  ╔══════════════════════════════│════════════════════════════════════════════════╗  │
│  ║  STAGE 3: 传感器融合层 (Sensor Fusion)                                          ║  │
│  ║                              ▼                                                ║  │
│  ║           ┌────────────────────────────────────────────┐                      ║  │
│  ║           │          ⏱️ 时间对齐引擎                     │                      ║  │
│  ║           │  ─────────────────────────────────         │                      ║  │
│  ║           │  • IMU 作为主时钟 (1666Hz 采样)               │                      ║  │
│  ║           │  • Vision 30fps → 插值对齐到 IMU             │                      ║  │
│  ║           │  • EMG 1000Hz → 三次样条插值对齐              │                      ║  │
│  ║           │  • Impact T=0 事件 → 跨设备同步锚点           │                      ║  │
│  ║           │  • 同步精度: 同Hub <10μs, 跨Hub <500μs       │                      ║  │
│  ║           └─────────────────────┬──────────────────────┘                      ║  │
│  ║                                 │                                             ║  │
│  ║           输出: 三模态时间对齐数据 (统一时间轴)                                     ║  │
│  ╚═════════════════════════════════│═════════════════════════════════════════════╝  │
│                                    │                                                │
│  ╔═════════════════════════════════│═════════════════════════════════════════════╗  │
│  ║  STAGE 4: 特征提取层 (Feature Extraction) — 12 核心指标                          ║  │
│  ║                                 ▼                                             ║  │
│  ║  ┌──────────────────┐    ┌──────────────────┐    ┌──────────────────┐         ║  │
│  ║  │  Vision (6 指标)  │    │  IMU (4 指标)    │    │   EMG (2 指标)    │         ║  │
│  ║  │  ────────────────│    │  ────────────────│    │  ────────────────│         ║  │
│  ║  │  • X-Factor      │    │  • 峰值角速度      │    │  • 核心激活 %     │         ║  │
│  ║  │  • X-Factor延展   │    │  • 节奏比         │    │  • 核心-前臂      │         ║  │
│  ║  │  • 转肩角         │    │  • 上杆时长       │    │    时序差         │         ║  │
│  ║  │  • 转髋角         │    │  • 下杆时长       │    │                  │         ║  │
│  ║  │  • S-Factor      │    │                  │    │  🌟 核心差异化:   │         ║  │
│  ║  │  • 侧移/抬头      │    │                  │    │   "为什么" 能力    │         ║  │
│  ║  └────────┬─────────┘    └────────┬─────────┘    └────────┬─────────┘         ║  │
│  ║           │                       │                       │                   ║  │
│  ║           │      WHAT: 发生了什么   │   WHEN: 何时发生       │   WHY: 为什么发生   ║  │
│  ║           └───────────────────────┼───────────────────────┘                   ║  │
│  ║                                   │                                           ║  │
│  ║                    【12 个结构化指标】                                           ║  │
│  ╚═══════════════════════════════════│═══════════════════════════════════════════╝  │
│                                      │                                              │
│  ╔═══════════════════════════════════│═══════════════════════════════════════════╗  │
│  ║  STAGE 5: 分析诊断层 (Analysis & Diagnosis)                                     ║  │
│  ║                                   ▼                                           ║  │
│  ║  ┌─────────────────────────────────────────────────────────────────────────┐  ║  │
│  ║  │                        8 阶段挥杆检测 (GolfDB 标准)                        │  ║  │
│  ║  │  Address → Takeaway → Backswing → Top → Downswing → Impact → Follow → Finish │
│  ║  └─────────────────────────────────┬───────────────────────────────────────┘  ║  │
│  ║                                    │                                          ║  │
│  ║                                    ▼                                          ║  │
│  ║  ┌──────────────────────────────────────────────────────────────────────────┐ ║  │
│  ║  │                           规则引擎 (6 条诊断规则)                           │ ║  │
│  ║  │  ═══════════════════════════════════════════════════════════════════════ │ ║  │
│  ║  │  P0 严重问题 (必须修正):                                                   │ ║  │
│  ║  │  ❌ 倒序运动链: EMG 前臂先于核心激活 (gap < -20ms)                          │ ║  │
│  ║  │  ❌ 过度手臂挥杆: Forearm/Core ratio > 1.3                                │ ║  │
│  ║  │  ───────────────────────────────────────────────────────────────────────│ ║  │
│  ║  │  P1 重要改进:                                                             │ ║  │
│  ║  │  ⚠️ 差异角过小: X-Factor < 20°                                            │ ║  │
│  ║  │  ⚠️ 节奏过快: Downswing < 0.20s                                           │ ║  │
│  ║  │  ⚠️ 节奏过慢: Downswing > 0.40s                                           │ ║  │
│  ║  │  ⚠️ 早释放: Wrist release < 40% downswing                                 │ ║  │
│  ║  └──────────────────────────────────┬───────────────────────────────────────┘ ║  │
│  ║                                     │                                         ║  │
│  ║                                     ▼                                         ║  │
│  ║  ┌──────────────────────────────────────────────────────────────────────────┐ ║  │
│  ║  │                    ⭐ 因果归因诊断 (核心差异化能力)                           │ ║  │
│  ║  │  ═══════════════════════════════════════════════════════════════════════  │ ║  │
│  ║  │  竞品 (Vision-only): "你的 X-Factor 不足" (只能说 WHAT)                      │ ║  │
│  ║  │  我们 (三模态融合): "你的核心肌群在下杆时未激活，导致 X-Factor 不足"              │ ║  │
│  ║  │                    → 同时告诉 WHAT + WHY + HOW TO FIX                      │ ║  │
│  ║  └──────────────────────────────────┬───────────────────────────────────────┘ ║  │
│  ║                                     │                                         ║  │
│  ║                    输出: 触发的规则 + 置信度分数 + 根因诊断                        ║  │
│  ╚═════════════════════════════════════│═════════════════════════════════════════╝  │
│                                        │                                            │
│  ╔═════════════════════════════════════│═════════════════════════════════════════╗  │
│  ║  STAGE 6: AI 反馈生成层 (AI Feedback Generation)                                ║  │
│  ║                                     ▼                                         ║  │
│  ║  ┌──────────────────────────────────────────────────────────────────────────┐ ║  │
│  ║  │                    Kinematic Prompts (结构化提示词)                        │ ║  │
│  ║  │  ═══════════════════════════════════════════════════════════════════════ │ ║  │
│  ║  │  将传感器数据结构化为 LLM 可理解格式:                                         │ ║  │
│  ║  │                                                                          │ ║  │
│  ║  │  "X-Factor: 42° ✅ (正常范围 35-55°)                                      │ ║  │
│  ║  │   Core activation: 30% ⚠️ (低于 50% 阈值)                                 │ ║  │
│  ║  │   Timing: 核心先于前臂 150ms ✅                                            │ ║  │
│  ║  │   Triggered rule: FALSE_COIL (P0)"                                       │ ║  │
│  ║  └──────────────────────────────────┬───────────────────────────────────────┘ ║  │
│  ║                                     │                                         ║  │
│  ║                                     ▼                                         ║  │
│  ║  ┌──────────────────────────────────────────────────────────────────────────┐ ║  │
│  ║  │                         LLM 翻译引擎                                      │ ║  │
│  ║  │  ═══════════════════════════════════════════════════════════════════════ │ ║  │
│  ║  │  输入: 结构化 Kinematic Prompts                                            │ ║  │
│  ║  │  处理: GPT-4o-mini / Gemini 2.5 Flash (200-500ms)                         │ ║  │
│  ║  │  输出: 教练级自然语言反馈                                                    │ ║  │
│  ║  │  ─────────────────────────────────────────────────────────────────────── │ ║  │
│  ║  │  示例输出:                                                                │ ║  │
│  ║  │  "看起来转够了 (42°)，但核心没发力 (30%)。                                    │ ║  │
│  ║  │   在下杆前收紧腹肌，让身体带动手臂。"                                          │ ║  │
│  ║  └──────────────────────────────────┬───────────────────────────────────────┘ ║  │
│  ╚═════════════════════════════════════│═════════════════════════════════════════╝  │
│                                        │                                            │
│  ╔═════════════════════════════════════│═════════════════════════════════════════╗  │
│  ║  STAGE 7: 用户反馈层 (User Feedback) — 挥杆后 <500ms 内呈现                       ║  │
│  ║                                     ▼                                         ║  │
│  ║  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌──────────────┐          ║  │
│  ║  │ 📱 App UI    │ │ 🔊 语音 TTS   │ │ 📳 触觉反馈   │ │ 👻 Ghost     │          ║  │
│  ║  │ ──────────── │ │ ──────────── │ │ ──────────── │ │ ──────────── │          ║  │
│  ║  │ • 简洁指标    │ │ • 教练语音     │ │ • 振动提示    │ │ • 骨架叠加    │          ║  │
│  ║  │   1-3 个     │ │ • 离线可用     │ │ • 即时反馈    │ │ • 动作对比    │          ║  │
│  ║  │ • 颜色编码    │ │ AVSpeech-     │ │ • 方向指引    │ │ • 参考轨迹    │          ║  │
│  ║  │   🟢🟡🔴     │ │  Synthesizer │ │              │ │              │          ║  │
│  ║  └──────────────┘ └──────────────┘ └──────────────┘ └──────────────┘          ║  │
│  ║                                                                               ║  │
│  ║  ┌───────────────────────────────────────────────────────────────────────────┐║  │
│  ║  │                           用户体验保证                                      │║  │
│  ║  │  • 挥杆结束 → 反馈呈现: <500ms (用户无感知延迟)                                │║  │
│  ║  │  • 语音反馈: 1-2 句话，可执行 ("收紧腹肌" vs 抽象建议)                          │║  │
│  ║  │  • 视觉反馈: 最多 3 个指标，避免信息过载                                       │║  │
│  ║  │  • 趋势追踪: 连续多次挥杆的改进/退步趋势                                        │║  │
│  ║  └───────────────────────────────────────────────────────────────────────────┘║  │
│  ╚═══════════════════════════════════════════════════════════════════════════════╝  │
│                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

**核心价值链** (数据流: Stage 1 → Stage 7):

| Stage | 层级 | 功能 | 关键技术 | 价值 |
|-------|------|------|----------|------|
| 1 | 用户挥杆 | 输入事件 | - | 触发数据采集 |
| 2 | 数据采集层 | 三模态数据采集 | ESP32 Sensor Hub + Swift App + MediaPipe | WHAT + WHEN + WHY 完整信息 |
| 3 | 传感器融合层 | 时间对齐 <10μs | IMU 主时钟 + Impact T=0 对齐 | 数据可比性、因果推断基础 |
| 4 | 特征提取层 | 12 个生物力学指标 | MediaPipe + NeuroKit2 + scipy | 从原始数据到可分析指标 |
| 5 | 分析诊断层 | 规则引擎 + 因果归因 | 8阶段检测、6条规则、因果诊断 | **核心差异化**: 告诉用户"为什么" |
| 6 | AI反馈层 | Kinematic Prompts → LLM | GPT-4o-mini / Gemini | 教练级自然语言反馈 |
| 7 | 用户反馈层 | 多模态反馈 <500ms | App UI、TTS、触觉、Ghost | 用户可执行的改进建议 |

---

## 2. 技术栈

> 本节为快速参考。详细规格见各专题文档，避免重复维护。

### 2.1 技术栈索引

| 层级 | 详细文档 | 核心技术 |
|------|----------|----------|
| **移动端 (Swift iOS)** | [ADR-0007](../decisions/0007-swift-ios-native.md), [SDK选型](../decisions/sdk-selection.md) | MediaPipeTasksVision + CoreBluetooth + AVFoundation |
| **开发环境 (Python)** | [SDK选型](../decisions/sdk-selection.md), [架构决策](../decisions/architecture-decisions-2025-12-23.md) | MediaPipe + NeuroKit2 + Polars + Rerun.io |
| **嵌入式 (ESP32)** | [ADR-0002](../decisions/0002-lsm6dsv16x-imu.md), [ADR-0005](../decisions/0005-esp32-s3-microcontroller.md) | ESP-IDF + FreeRTOS + BLE 5.0 |
| **传感器** | [数据处理与指标计算](./sensor-data-processing.md) | LSM6DSV16X (IMU) + MyoWare 2.0 (EMG) |
| **时间同步** | [数据管道](./data-pipeline-and-ai.md#sensor-hub-架构-2025-12-推荐) | Sensor Hub + Impact T=0 对齐 |
| **硬件设计** | [硬件购买清单](../decisions/architecture-decisions-2025-12-23.md#43-硬件购买清单) | KiCad PCB 设计 |

### 2.2 开发 vs 生产架构

> 📐 **架构决策**: 见 [ADR-0008 Desktop→Mobile](../decisions/0008-desktop-to-mobile-architecture.md)

```text
┌─────────────────────────────────────────────────────────────────────────────┐
│                    Development vs Production Architecture                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   DEVELOPMENT (Phase 1-3)                 PRODUCTION (Phase 4)              │
│   ───────────────────────                 ────────────────────              │
│                                                                             │
│   ┌─────────────┐                         ┌─────────────┐                   │
│   │  Python     │   Same MediaPipe        │  Swift      │                   │
│   │  Desktop    │   .tflite models   ───► │  iOS App    │                   │
│   │  + Rerun.io │                         │  On-device  │                   │
│   └─────────────┘                         └─────────────┘                   │
│        │                                        │                           │
│        ▼                                        ▼                           │
│   Mock/Real data                           Real sensors                     │
│   Visualization                            Real-time UI                     │
│   Algorithm validation                     User feedback                    │
│                                                                             │
│   PURPOSE: Debug, iterate, validate       PURPOSE: App Store product       │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.3 混合推理架构

基于 2025 最佳实践，采用 On-device + Cloud 混合架构:

| 组件 | 位置 | 延迟要求 | 理由 |
|------|------|----------|------|
| **Pose Estimation** | 📱 On-device | <33ms | 实时、隐私、离线 |
| **Sensor Fusion** | 📱 On-device | <10ms | 低延迟 |
| **Rule Engine** | 📱 On-device | <5ms | 确定性 |
| **LLM Feedback** | ☁️ Cloud API | 200-500ms | 复杂推理，挥杆后可接受 |
| **Data Sync** | ☁️ Cloud (Post-MVP) | N/A | 趋势分析、跨设备 |

> 📐 **详细规格**: [数据管道与AI](./data-pipeline-and-ai.md) | [模块化架构](./modular-architecture.md)

---

## 3. 规格文档索引

### 3.1 核心规格

| 规格类别 | 详细文档 | 核心内容 |
|----------|----------|----------|
| **12 测量指标** | [数据处理与指标计算](./sensor-data-processing.md) | Vision (6) + IMU (4) + EMG (2) |
| **6 诊断规则** | [MVP 开发计划 §8.2](./mvp-plan.md#82-mvp-6-条诊断规则) | P0 (2条) + P1 (4条) |
| **反馈模式** | [实时反馈规格](../specs/real-time-feedback.md) | 3种模式: Setup / Slow Motion / Full Speed |
| **产品层级** | [产品层级](../specs/product-tiers.md) | Lite / Pro / Elite 三个版本 |

### 3.2 架构决策

| 决策 | 结果 | ADR |
|------|------|-----|
| 移动端框架 | Swift iOS 原生 | [ADR-0007](../decisions/0007-swift-ios-native.md) |
| LLM Provider | GPT-4o-mini | [架构决策](../decisions/architecture-decisions-2025-12-23.md) |
| IMU 选型 | LSM6DSV16X | [ADR-0002](../decisions/0002-lsm6dsv16x-imu.md) |
| MCU 选型 | ESP32-S3 | [ADR-0005](../decisions/0005-esp32-s3-microcontroller.md) |
| EMG 选型 | MyoWare 2.0 + Link Shield | [架构决策](../decisions/architecture-decisions-2025-12-23.md) |
| 时间同步 | Sensor Hub + Impact 对齐 | [数据管道](./data-pipeline-and-ai.md) |
| 升级路径 | LEGO block 可替换设计 | [模块化架构](./modular-architecture.md) |

### 3.3 开发计划

| 文档 | 内容 |
|------|------|
| **[MVP 开发计划](./mvp-plan.md)** | MVP 阶段划分、验收标准、Post-MVP 路线图 |
| [移动开发指南](../../development/mobile/development.md) | Swift iOS 开发规范 |

---

## 4. 版本历史

| 版本 | 日期 | 修改内容 |
|------|------|----------|
| 1.0 | 2025-12-18 | 初始版本，整合所有详细规格 |
| 1.1 | 2025-12-23 | 增加 Sensor Hub 架构, 更新硬件选型, 澄清 BLE 时间同步策略 |
| 2.0 | 2025-12-25 | **重大重构**: 并行开发策略 (Track A/B)、Mock Data 解耦、测试金字塔、简化章节结构 |
| 2.1 | 2025-12-25 | 新增 Section 2.6 开发阶段 vs 产品阶段、Mermaid 工作流图、2025 移动端最佳实践 |
| 2.2 | 2025-12-25 | 修复 Section 1.2 架构图顺序 (改为 top-to-bottom 数据流) |
| 3.0 | 2025-12-25 | **重大变更**: Flutter → Swift 原生 iOS 开发 (见 [ADR-0007](../decisions/0007-swift-ios-native.md)) |
| 3.1 | 2025-12-25 | **重构 1.2**: 静态层级图 → 7阶段动态数据流图 (从挥杆到反馈的完整端到端流程) |
| 3.2-3.9 | 2025-12-25-27 | 多次重构优化，详见 git history |
| 4.0 | 2025-12-27 | **文档拆分**: MVP 相关内容迁移至 [mvp-plan.md](./mvp-plan.md)，本文档聚焦长期稳定架构 |

---

**最后更新**: 2025-12-27
**维护者**: Movement Chain AI Team
