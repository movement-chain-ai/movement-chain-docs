# 系统架构 System Architecture

> **文档角色**: 总纲 (Hub) - 系统核心设计文档，所有详细规格文档的入口
>
> **目标读者**: 技术负责人、新加入的团队成员、投资者
>
> **阅读时间**: 15分钟

---

## 1. 系统概览

### 1.1 产品愿景

**一句话**: 基于 Vision + IMU + EMG 三模态融合的高尔夫挥杆分析系统，通过 AI 教练提供可执行的改进建议。

**核心差异化**: EMG 肌肉激活检测 — 竞品只能告诉你"什么错了"，我们能告诉你"为什么错了"。

### 1.2 系统架构图 {#12-完整系统架构}

```text
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                     Movement Chain AI — 完整产品数据流                                │
│                     (端到端产品工作原理: 从挥杆到反馈)                                   │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                     │
│  ╔═══════════════════════════════════════════════════════════════════════════════╗  │
│  ║  STAGE 1: 用户挥杆 (User Swings)                                               ║  │
│  ║                                                                               ║  │
│  ║                        🏌️ 高尔夫球手挥杆                                        ║  │
│  ║                             │                                                 ║  │
│  ║      ┌──────────────────────┼──────────────────────┐                          ║  │
│  ║      │                      │                      │                          ║  │
│  ║      ▼                      ▼                      ▼                          ║  │
│  ║ 📹 iPhone Camera       💪 Wearable Sensors    💪 Wearable Sensors             ║  │
│  ║  (Vision 30fps)         (Arm Hub)             (Core Hub)                      ║  │
│  ╚═══════════════════════════════════════════════════════════════════════════════╝  │
│                                       │                                             │
│  ╔═══════════════════════════════════════════════════════════════════════════════╗  │
│  ║  STAGE 2: 数据采集层 (Data Collection)                                          ║  │
│  ║                                                                                ║  │
│  ║  ┌─────────────────┐     ┌─────────────────────┐    ┌─────────────────────┐    ║  │
│  ║  │  📹 Vision       │    │  🔄 Arm Hub         │    │  🔄 Core Hub        │    ║  │
│  ║  │  ─────────────   │    │  ─────────────────  │    │  ─────────────────  │    ║  │
│  ║  │  • iPhone Camera │    │  • ESP32-S3         │    │  • ESP32-S3         │    ║  │
│  ║  │  • MediaPipe iOS │    │  • LSM6DSV16X (IMU) │    │  • LSM6DSV16X (IMU) │    ║  │
│  ║  │  • 33 keypoints  │    │  • MyoWare 2.0 (EMG)│    │  • MyoWare 2.0 (EMG)│    ║  │
│  ║  │  • 30 fps        │    │  • 共享时钟源         │    │  • 共享时钟源         │   ║  │
│  ║  └────────┬─────────┘    └─────────┬───────────┘    └─────────┬───────────┘    ║  │
│  ║           │                        │                          │                ║  │
│  ║           │                        └───────────┬──────────────┘                ║  │
│  ║           │                                    │                               ║  │
│  ║           │ Native SDK                         │ BLE 5.0                       ║  │
│  ║           │ (No latency)                       │ (源端时间戳，消除抖动)            ║  │
│  ║           │                                    │                               ║  │
│  ║           └──────────────────┬─────────────────┘                               ║  │
│  ║                              ▼                                                 ║  │
│  ║                    ┌─────────────────────┐                                     ║  │
│  ║                    │  📱 Swift iOS App   │                                     ║  │
│  ║                    │  • MediaPipeTasksVision                                   ║  │
│  ║                    │  • CoreBluetooth    │                                     ║  │
│  ║                    │  • 数据接收与缓存     │                                      ║  │
│  ║                    └─────────┬───────────┘                                     ║  │
│  ║                                                                                ║  │
│  ║  【空间姿态 WHAT】       【运动时序 WHEN】         【肌肉激活 WHY】                  ║  │
│  ╚══════════════════════════════│════════════════════════════════════════════════╝  │
│                                 │                                                   │
│  ╔══════════════════════════════│════════════════════════════════════════════════╗  │
│  ║  STAGE 3: 传感器融合层 (Sensor Fusion)                                          ║  │
│  ║                              ▼                                                ║  │
│  ║           ┌────────────────────────────────────────────┐                      ║  │
│  ║           │          ⏱️ 时间对齐引擎                     │                      ║  │
│  ║           │  ─────────────────────────────────         │                      ║  │
│  ║           │  • IMU 作为主时钟 (1666Hz 采样)               │                      ║  │
│  ║           │  • Vision 30fps → 插值对齐到 IMU             │                      ║  │
│  ║           │  • EMG 1000Hz → 三次样条插值对齐              │                      ║  │
│  ║           │  • Impact T=0 事件 → 跨设备同步锚点           │                      ║  │
│  ║           │  • 同步精度: 同Hub <10μs, 跨Hub <500μs       │                      ║  │
│  ║           └─────────────────────┬──────────────────────┘                      ║  │
│  ║                                 │                                             ║  │
│  ║           输出: 三模态时间对齐数据 (统一时间轴)                                     ║  │
│  ╚═════════════════════════════════│═════════════════════════════════════════════╝  │
│                                    │                                                │
│  ╔═════════════════════════════════│═════════════════════════════════════════════╗  │
│  ║  STAGE 4: 特征提取层 (Feature Extraction) — 12 核心指标                          ║  │
│  ║                                 ▼                                             ║  │
│  ║  ┌──────────────────┐    ┌──────────────────┐    ┌──────────────────┐         ║  │
│  ║  │  Vision (6 指标)  │    │  IMU (4 指标)    │    │   EMG (2 指标)    │         ║  │
│  ║  │  ────────────────│    │  ────────────────│    │  ────────────────│         ║  │
│  ║  │  • X-Factor      │    │  • 峰值角速度      │    │  • 核心激活 %     │         ║  │
│  ║  │  • X-Factor延展   │    │  • 节奏比         │    │  • 核心-前臂      │         ║  │
│  ║  │  • 转肩角         │    │  • 上杆时长       │    │    时序差         │         ║  │
│  ║  │  • 转髋角         │    │  • 下杆时长       │    │                  │         ║  │
│  ║  │  • S-Factor      │    │                  │    │  🌟 核心差异化:   │         ║  │
│  ║  │  • 侧移/抬头      │    │                  │    │   "为什么" 能力    │         ║  │
│  ║  └────────┬─────────┘    └────────┬─────────┘    └────────┬─────────┘         ║  │
│  ║           │                       │                       │                   ║  │
│  ║           │      WHAT: 发生了什么   │   WHEN: 何时发生       │   WHY: 为什么发生   ║  │
│  ║           └───────────────────────┼───────────────────────┘                   ║  │
│  ║                                   │                                           ║  │
│  ║                    【12 个结构化指标】                                           ║  │
│  ╚═══════════════════════════════════│═══════════════════════════════════════════╝  │
│                                      │                                              │
│  ╔═══════════════════════════════════│═══════════════════════════════════════════╗  │
│  ║  STAGE 5: 分析诊断层 (Analysis & Diagnosis)                                     ║  │
│  ║                                   ▼                                           ║  │
│  ║  ┌─────────────────────────────────────────────────────────────────────────┐  ║  │
│  ║  │                        8 阶段挥杆检测 (GolfDB 标准)                        │  ║  │
│  ║  │  Address → Takeaway → Backswing → Top → Downswing → Impact → Follow → Finish │
│  ║  └─────────────────────────────────┬───────────────────────────────────────┘  ║  │
│  ║                                    │                                          ║  │
│  ║                                    ▼                                          ║  │
│  ║  ┌──────────────────────────────────────────────────────────────────────────┐ ║  │
│  ║  │                           规则引擎 (6 条诊断规则)                           │ ║  │
│  ║  │  ═══════════════════════════════════════════════════════════════════════ │ ║  │
│  ║  │  P0 严重问题 (必须修正):                                                   │ ║  │
│  ║  │  ❌ 倒序运动链: EMG 前臂先于核心激活 (gap < -20ms)                          │ ║  │
│  ║  │  ❌ 过度手臂挥杆: Forearm/Core ratio > 1.3                                │ ║  │
│  ║  │  ───────────────────────────────────────────────────────────────────────│ ║  │
│  ║  │  P1 重要改进:                                                             │ ║  │
│  ║  │  ⚠️ 差异角过小: X-Factor < 20°                                            │ ║  │
│  ║  │  ⚠️ 节奏过快: Downswing < 0.20s                                           │ ║  │
│  ║  │  ⚠️ 节奏过慢: Downswing > 0.40s                                           │ ║  │
│  ║  │  ⚠️ 早释放: Wrist release < 40% downswing                                 │ ║  │
│  ║  └──────────────────────────────────┬───────────────────────────────────────┘ ║  │
│  ║                                     │                                         ║  │
│  ║                                     ▼                                         ║  │
│  ║  ┌──────────────────────────────────────────────────────────────────────────┐ ║  │
│  ║  │                    ⭐ 因果归因诊断 (核心差异化能力)                           │ ║  │
│  ║  │  ═══════════════════════════════════════════════════════════════════════  │ ║  │
│  ║  │  竞品 (Vision-only): "你的 X-Factor 不足" (只能说 WHAT)                      │ ║  │
│  ║  │  我们 (三模态融合): "你的核心肌群在下杆时未激活，导致 X-Factor 不足"              │ ║  │
│  ║  │                    → 同时告诉 WHAT + WHY + HOW TO FIX                      │ ║  │
│  ║  └──────────────────────────────────┬───────────────────────────────────────┘ ║  │
│  ║                                     │                                         ║  │
│  ║                    输出: 触发的规则 + 置信度分数 + 根因诊断                        ║  │
│  ╚═════════════════════════════════════│═════════════════════════════════════════╝  │
│                                        │                                            │
│  ╔═════════════════════════════════════│═════════════════════════════════════════╗  │
│  ║  STAGE 6: AI 反馈生成层 (AI Feedback Generation)                                ║  │
│  ║                                     ▼                                         ║  │
│  ║  ┌──────────────────────────────────────────────────────────────────────────┐ ║  │
│  ║  │                    Kinematic Prompts (结构化提示词)                        │ ║  │
│  ║  │  ═══════════════════════════════════════════════════════════════════════ │ ║  │
│  ║  │  将传感器数据结构化为 LLM 可理解格式:                                         │ ║  │
│  ║  │                                                                          │ ║  │
│  ║  │  "X-Factor: 42° ✅ (正常范围 35-55°)                                      │ ║  │
│  ║  │   Core activation: 30% ⚠️ (低于 50% 阈值)                                 │ ║  │
│  ║  │   Timing: 核心先于前臂 150ms ✅                                            │ ║  │
│  ║  │   Triggered rule: FALSE_COIL (P0)"                                       │ ║  │
│  ║  └──────────────────────────────────┬───────────────────────────────────────┘ ║  │
│  ║                                     │                                         ║  │
│  ║                                     ▼                                         ║  │
│  ║  ┌──────────────────────────────────────────────────────────────────────────┐ ║  │
│  ║  │                         LLM 翻译引擎                                      │ ║  │
│  ║  │  ═══════════════════════════════════════════════════════════════════════ │ ║  │
│  ║  │  输入: 结构化 Kinematic Prompts                                            │ ║  │
│  ║  │  处理: GPT-4o-mini / Gemini 2.5 Flash (200-500ms)                         │ ║  │
│  ║  │  输出: 教练级自然语言反馈                                                    │ ║  │
│  ║  │  ─────────────────────────────────────────────────────────────────────── │ ║  │
│  ║  │  示例输出:                                                                │ ║  │
│  ║  │  "看起来转够了 (42°)，但核心没发力 (30%)。                                    │ ║  │
│  ║  │   在下杆前收紧腹肌，让身体带动手臂。"                                          │ ║  │
│  ║  └──────────────────────────────────┬───────────────────────────────────────┘ ║  │
│  ╚═════════════════════════════════════│═════════════════════════════════════════╝  │
│                                        │                                            │
│  ╔═════════════════════════════════════│═════════════════════════════════════════╗  │
│  ║  STAGE 7: 用户反馈层 (User Feedback) — 挥杆后 <500ms 内呈现                       ║  │
│  ║                                     ▼                                         ║  │
│  ║  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌──────────────┐          ║  │
│  ║  │ 📱 App UI    │ │ 🔊 语音 TTS   │ │ 📳 触觉反馈   │ │ 👻 Ghost     │          ║  │
│  ║  │ ──────────── │ │ ──────────── │ │ ──────────── │ │ ──────────── │          ║  │
│  ║  │ • 简洁指标    │ │ • 教练语音     │ │ • 振动提示    │ │ • 骨架叠加    │          ║  │
│  ║  │   1-3 个     │ │ • 离线可用     │ │ • 即时反馈    │ │ • 动作对比    │          ║  │
│  ║  │ • 颜色编码    │ │ AVSpeech-     │ │ • 方向指引    │ │ • 参考轨迹    │          ║  │
│  ║  │   🟢🟡🔴     │ │  Synthesizer │ │              │ │              │          ║  │
│  ║  └──────────────┘ └──────────────┘ └──────────────┘ └──────────────┘          ║  │
│  ║                                                                               ║  │
│  ║  ┌───────────────────────────────────────────────────────────────────────────┐║  │
│  ║  │                           用户体验保证                                      │║  │
│  ║  │  • 挥杆结束 → 反馈呈现: <500ms (用户无感知延迟)                                │║  │
│  ║  │  • 语音反馈: 1-2 句话，可执行 ("收紧腹肌" vs 抽象建议)                          │║  │
│  ║  │  • 视觉反馈: 最多 3 个指标，避免信息过载                                       │║  │
│  ║  │  • 趋势追踪: 连续多次挥杆的改进/退步趋势                                        │║  │
│  ║  └───────────────────────────────────────────────────────────────────────────┘║  │
│  ╚═══════════════════════════════════════════════════════════════════════════════╝  │
│                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

### 1.3 七层架构详解 {#seven-layer-architecture}

数据从用户挥杆到最终反馈，经过 7 层处理。每一层都有明确的功能边界和技术实现。

---

#### 1.3.1 用户挥杆 {#stage-1}

**功能**: 系统的输入事件，触发整个数据采集与分析流程。

**数据流**:
```text
🏌️ 高尔夫球手挥杆
        │
        ├──→ 📹 iPhone Camera (视觉捕捉)
        ├──→ 💪 Arm Hub (前臂传感器)
        └──→ 💪 Core Hub (核心传感器)
```

**价值**: 一次挥杆同时触发三种传感器的并行采集，确保多模态数据的时间起点一致性。

---

#### 1.3.2 数据采集层 {#stage-2}

**功能**: 三模态数据的并行采集，获取挥杆的完整信息。

**三模态数据**:

| 模态 | 传感器 | 采样率 | 数据内容 | 回答问题 |
|------|--------|--------|----------|----------|
| **Vision** | iPhone Camera + MediaPipe | 30 fps | 33 个骨骼关键点坐标 | **WHAT**: 身体姿态是什么样的？ |
| **IMU** | LSM6DSV16X (陀螺仪+加速度计) | 1666 Hz | 角速度、加速度、时间戳 | **WHEN**: 各阶段何时发生？ |
| **EMG** | MyoWare 2.0 | 1000 Hz | 肌肉电信号强度 | **WHY**: 为什么会这样？ |

**关键技术**:

| 组件 | 技术选型 | 核心能力 |
|------|----------|----------|
| **Sensor Hub** | ESP32-S3 MCU | 多传感器共享时钟源，源端时间戳 |
| **BLE 传输** | BLE 5.0 + 源端时间戳 | 消除传输抖动，保留精确时序 |
| **Vision SDK** | MediaPipeTasksVision (iOS) | 设备端实时姿态估计，无网络延迟 |
| **App 接收** | Swift + CoreBluetooth | 原生性能，低功耗蓝牙管理 |

**价值**:
- **信息完整性**: Vision 告诉你"发生了什么"，IMU 告诉你"何时发生"，EMG 告诉你"为什么发生"
- **竞品对比**: 纯 Vision 方案只有 WHAT，我们有 WHAT + WHEN + WHY

> 📐 详见: [数据处理与指标计算](./sensor-data-processing.md) — 各传感器的数据格式与处理

---

#### 1.3.3 传感器融合层 {#stage-3}

**功能**: 将三种不同采样率的数据对齐到统一时间轴，为后续分析提供可比较的数据基础。

**核心挑战**:
```text
问题: 三种传感器采样率不同，如何对齐？

   Vision:   |----33ms----|----33ms----|----33ms----|  (30 fps)
   IMU:      |0.6ms|0.6ms|0.6ms|...                    (1666 Hz)
   EMG:      |-1ms-|-1ms-|-1ms-|...                    (1000 Hz)
```

**解决方案**: IMU 主时钟 + Impact T=0 对齐

| 策略 | 实现方式 | 精度 |
|------|----------|------|
| **IMU 作为主时钟** | 所有数据插值对齐到 IMU 时间轴 | 同 Hub 内 <10μs |
| **Impact T=0 锚点** | 击球瞬间作为跨设备同步参考点 | 跨 Hub <500μs |
| **三次样条插值** | 低采样率数据 (Vision) 插值到高采样率 | 保持曲线平滑 |

**关键技术**:

| 技术 | 作用 |
|------|------|
| **Sensor Hub 架构** | 同一 Hub 内的 IMU+EMG 共享时钟源，同步精度 <10μs |
| **Impact 检测** | 通过 IMU 陀螺仪峰值检测击球时刻，作为 T=0 |
| **跨 Hub 对齐** | 多个 Sensor Hub 都能检测到 Impact 振动，对齐各自的 T=0 |

**价值**:
- **因果推断基础**: 只有时间精确对齐，才能判断"核心激活是否先于手臂动作"
- **数据可比性**: 不同挥杆、不同用户的数据可以直接比较

> 📐 详见: [数据管道与AI](./data-flow.md#sensor-hub-架构-2025-12-推荐) — 时间同步策略

---

#### 1.3.4 特征提取层 {#stage-4}

**功能**: 从原始传感器数据中提取 12 个标准化的生物力学指标，将"原始波形"转换为"可分析数值"。

**12 核心指标**:

| 来源 | 指标 | 英文 | 计算方式 | 正常范围 |
|------|------|------|----------|----------|
| **Vision** | X-Factor | X-Factor | 肩膀旋转角 - 髋部旋转角 | 35°-55° |
| | X-Factor 延展 | X-Factor Stretch | X-Factor 在下杆初期的增加值 | 5°-15° |
| | 转肩角 | Shoulder Turn | 肩线与目标线夹角 | 80°-110° |
| | 转髋角 | Hip Turn | 髋线与目标线夹角 | 35°-55° |
| | S-Factor | S-Factor | 肩部倾斜角度 | 20°-35° |
| | 侧移/抬头 | Sway/Lift | 头部/髋部水平位移 | <5cm |
| **IMU** | 峰值角速度 | Peak Angular Velocity | gyro_z 负峰值 | 800°-1200°/s |
| | 节奏比 | Tempo Ratio | 上杆时间 / 下杆时间 | 2.5:1 - 3.5:1 |
| | 上杆时长 | Backswing Duration | Address → Top 时间 | 0.8s - 1.2s |
| | 下杆时长 | Downswing Duration | Top → Impact 时间 | 0.20s - 0.35s |
| **EMG** | 核心激活 % | Core Activation % | 核心肌群 RMS / MVC | >50% |
| | 核心-前臂时序差 | Core-Forearm Timing Gap | 核心激活时刻 - 前臂激活时刻 | >20ms (核心先) |

**关键技术**:

| 库 | 用途 | 处理内容 |
|----|----|----------|
| **MediaPipe** | Vision 指标 | 从 33 个关键点计算角度、位移 |
| **scipy** | IMU 指标 | 信号滤波、峰值检测、零交叉检测 |
| **NeuroKit2** | EMG 指标 | 肌电信号处理、激活时刻检测 |
| **Polars** | 数据处理 | 高性能时间序列操作 |

**价值**:
- **标准化**: 将不同用户、不同设备的原始数据转换为可比较的标准指标
- **可解释性**: 每个指标都有明确的生物力学含义，用户可以理解
- **诊断基础**: 为下一层的规则引擎提供结构化输入

> 📐 详见: [数据处理与指标计算](./sensor-data-processing.md) — 12 个指标的详细计算公式

---

#### 1.3.5 分析诊断层 {#stage-5}

**功能**: 基于 12 个指标，执行规则引擎诊断和因果归因分析。这是系统的**核心差异化能力**。

**8 阶段挥杆检测** (基于 GolfDB 标准):
```text
Address → Takeaway → Backswing → Top → Downswing → Impact → Follow-through → Finish
   │          │           │        │        │          │          │             │
   ▼          ▼           ▼        ▼        ▼          ▼          ▼             ▼
 站姿设置   起杆启动    上杆过程  杆顶位置  下杆加速   击球时刻    顺势跟随      收杆结束
```

**6 条诊断规则**:

| 优先级 | 规则名称 | 触发条件 | 诊断结果 |
|--------|----------|----------|----------|
| **P0** | 倒序运动链 | EMG 前臂先于核心激活 (gap < -20ms) | 严重问题：手臂主导而非身体主导 |
| **P0** | 过度手臂挥杆 | Forearm/Core ratio > 1.3 | 严重问题：核心力量未充分参与 |
| **P1** | 差异角过小 | X-Factor < 20° | 身体扭转不足，力量储备不够 |
| **P1** | 节奏过快 | Downswing < 0.20s | 下杆太急，节奏失控 |
| **P1** | 节奏过慢 | Downswing > 0.40s | 下杆迟缓，力量流失 |
| **P1** | 早释放 | Wrist release < 40% downswing | 释放角度过早，损失杆头速度 |

**因果归因诊断** (核心差异化):

```text
竞品 (Vision-only):
┌─────────────────────────────────────────────────────────────┐
│  "你的 X-Factor 只有 18°，低于正常范围"                        │
│   → 只能告诉 WHAT（发生了什么）                               │
│   → 用户不知道为什么，也不知道怎么改                            │
└─────────────────────────────────────────────────────────────┘

我们 (三模态融合):
┌─────────────────────────────────────────────────────────────┐
│  "你的 X-Factor 只有 18°，因为核心肌群在下杆时只有 30% 激活"    │
│   → WHAT: X-Factor 不足                                     │
│   → WHY: 核心激活不够                                        │
│   → HOW TO FIX: 在下杆前收紧腹肌，让身体带动手臂                │
└─────────────────────────────────────────────────────────────┘
```

**关键技术**:

| 技术 | 作用 |
|------|------|
| **规则引擎** | 基于阈值的条件判断，确定性输出 |
| **EMG 时序分析** | 检测肌肉激活顺序，判断运动链是否正确 |
| **因果推断** | 关联 EMG 激活模式与 Vision 姿态问题 |

**价值**:
- **核心差异化**: 这是我们与所有 Vision-only 竞品的本质区别
- **可执行建议**: 不只是"什么错了"，还有"为什么错"和"怎么改"
- **教练替代**: 提供接近人类教练的诊断深度

> 📐 详见: [MVP 开发计划 §7.2](./mvp-plan.md#72-mvp-6-条诊断规则) — 6 条规则的详细逻辑

---

#### 1.3.6 AI 反馈生成层 {#stage-6}

**功能**: 将结构化的诊断结果转换为自然语言的教练反馈。

**Kinematic Prompts** (结构化提示词):

将传感器数据和诊断结果格式化为 LLM 可理解的结构:

```text
用户挥杆数据:
─────────────────────────────────────
X-Factor: 42° ✅ (正常范围 35-55°)
Core activation: 30% ⚠️ (低于 50% 阈值)
Timing: 核心先于前臂 150ms ✅
Peak velocity: 920°/s ✅

触发规则:
─────────────────────────────────────
• LOW_CORE_ACTIVATION (P1) - 核心激活不足
• 置信度: 0.85

请生成教练反馈...
```

**LLM 翻译引擎**:

| 配置 | 选择 | 理由 |
|------|------|------|
| **模型** | GPT-4o-mini / Gemini 2.5 Flash | 性价比高，响应快 |
| **延迟** | 200-500ms | 挥杆后可接受，非实时要求 |
| **部署** | Cloud API | 复杂推理，模型更新灵活 |
| **Fallback** | 本地模板 | 网络不可用时的备用方案 |

**输出示例**:

```text
LLM 输入:
  X-Factor=42°, Core=30%, Rule=LOW_CORE_ACTIVATION

LLM 输出:
  "看起来转够了 (42°)，但核心没发力 (30%)。
   在下杆前收紧腹肌，让身体带动手臂。"
```

**关键技术**:

| 技术 | 作用 |
|------|------|
| **Prompt Engineering** | 设计让 LLM 输出简洁、可执行建议的提示词 |
| **结构化输入** | 将数值数据转换为 LLM 易理解的格式 |
| **输出约束** | 限制输出为 1-2 句话，避免啰嗦 |

**价值**:
- **自然语言**: 用户听到的是人话，不是数据
- **可执行**: 建议是具体动作（"收紧腹肌"），不是抽象概念
- **个性化**: 根据具体数据定制反馈内容

> 📐 详见: [数据管道与AI](./data-flow.md) — Kinematic Prompts 详细设计

---

#### 1.3.7 用户反馈层 {#stage-7}

**功能**: 将 AI 生成的反馈通过多种模态呈现给用户，确保挥杆后 <500ms 内收到反馈。

**四种反馈通道**:

| 通道 | 载体 | 内容 | 使用场景 |
|------|------|------|----------|
| **📱 App UI** | 手机屏幕 | 1-3 个关键指标 + 颜色编码 (🟢🟡🔴) | 练习后查看详情 |
| **🔊 语音 TTS** | AirPods/扬声器 | 1-2 句教练建议 | 练习中即时反馈 |
| **📳 触觉反馈** | Apple Watch/手机 | 振动模式提示问题类型 | 不看屏幕时的即时提醒 |
| **👻 Ghost 叠加** | AR 骨架叠加 | 理想轨迹 vs 实际轨迹对比 | 慢动作回放时的视觉对比 |

**延迟预算**:

```text
挥杆结束 → 反馈呈现: <500ms

时间分配:
─────────────────────────────────────
  Impact 检测:        ~0ms   (实时)
  数据传输 (BLE):    ~50ms
  传感器融合:        ~10ms
  特征提取:          ~20ms
  规则引擎:           ~5ms
  LLM 生成:        ~300ms
  UI 渲染:          ~50ms
─────────────────────────────────────
  总计:            ~435ms  ✅ <500ms
```

**用户体验设计原则**:

| 原则 | 实现 |
|------|------|
| **不过载** | 每次最多显示 3 个指标，避免信息轰炸 |
| **可执行** | 建议是具体动作（"收紧腹肌"），不是抽象概念（"增加核心参与度"） |
| **即时性** | 用户无感知延迟，反馈像是"实时"的 |
| **渐进式** | 先给简单提示，用户想看详情再展开 |

**关键技术**:

| 技术 | 用途 |
|------|------|
| **AVSpeechSynthesizer** | iOS 原生 TTS，离线可用 |
| **Core Haptics** | 精细触觉反馈控制 |
| **ARKit** | Ghost 骨架叠加渲染 |
| **SwiftUI** | 响应式 UI，快速渲染 |

**价值**:
- **即时反馈**: 让用户在挥杆记忆最新鲜时收到建议
- **多模态适应**: 不同场景（看手机/不看手机）都能接收反馈
- **渐进复杂度**: 从简单提示到详细分析，用户自主选择深度

> 📐 详见: [三个训练场景](../specs/assessment-mode.md) — 三个训练场景的详细设计

---

## 2. 技术栈

> 本节为快速参考。详细规格见各专题文档，避免重复维护。

### 2.1 技术栈索引

| 层级 | 详细文档 | 核心技术 |
|------|----------|----------|
| **移动端 (Swift iOS)** | [ADR-0007](../decisions/0007-swift-ios-native.md), [SDK选型](../decisions/sdk-selection.md) | MediaPipeTasksVision + CoreBluetooth + AVFoundation |
| **开发环境 (Python)** | [SDK选型](../decisions/sdk-selection.md), [架构决策](../decisions/architecture-decisions-2025-12-23.md) | MediaPipe + NeuroKit2 + Polars + Rerun.io |
| **嵌入式 (ESP32)** | [ADR-0002](../decisions/0002-lsm6dsv16x-imu.md), [ADR-0005](../decisions/0005-esp32-s3-microcontroller.md) | ESP-IDF + FreeRTOS + BLE 5.0 |
| **传感器** | [数据处理与指标计算](./sensor-data-processing.md) | LSM6DSV16X (IMU) + MyoWare 2.0 (EMG) |
| **时间同步** | [数据管道](./data-flow.md#sensor-hub-架构-2025-12-推荐) | Sensor Hub + Impact T=0 对齐 |
| **硬件设计** | [硬件购买清单](../decisions/architecture-decisions-2025-12-23.md#43-硬件购买清单) | KiCad PCB 设计 |

### 2.2 开发 vs 生产架构

> 📐 **架构决策**: 见 [ADR-0008 Desktop→Mobile](../decisions/0008-desktop-to-mobile-architecture.md)

```text
┌─────────────────────────────────────────────────────────────────────────────┐
│                    Development vs Production Architecture                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   DEVELOPMENT (Phase 1-3)                 PRODUCTION (Phase 4)              │
│   ───────────────────────                 ────────────────────              │
│                                                                             │
│   ┌─────────────┐                         ┌─────────────┐                   │
│   │  Python     │   Same MediaPipe        │  Swift      │                   │
│   │  Desktop    │   .tflite models   ───► │  iOS App    │                   │
│   │  + Rerun.io │                         │  On-device  │                   │
│   └─────────────┘                         └─────────────┘                   │
│        │                                        │                           │
│        ▼                                        ▼                           │
│   Mock/Real data                           Real sensors                     │
│   Visualization                            Real-time UI                     │
│   Algorithm validation                     User feedback                    │
│                                                                             │
│   PURPOSE: Debug, iterate, validate       PURPOSE: App Store product       │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.3 混合推理架构

基于 2025 最佳实践，采用 On-device + Cloud 混合架构:

| 组件 | 位置 | 延迟要求 | 理由 |
|------|------|----------|------|
| **Pose Estimation** | 📱 On-device | <33ms | 实时、隐私、离线 |
| **Sensor Fusion** | 📱 On-device | <10ms | 低延迟 |
| **Rule Engine** | 📱 On-device | <5ms | 确定性 |
| **LLM Feedback** | ☁️ Cloud API | 200-500ms | 复杂推理，挥杆后可接受 |
| **Data Sync** | ☁️ Cloud (Post-MVP) | N/A | 趋势分析、跨设备 |

> 📐 **详细规格**: [数据管道与AI](./data-flow.md) | [模块化设计](./modular-architecture.md)

---

## 3. 规格文档索引

### 3.1 核心规格

| 规格类别 | 详细文档 | 核心内容 |
|----------|----------|----------|
| **12 测量指标** | [数据处理与指标计算](./sensor-data-processing.md) | Vision (6) + IMU (4) + EMG (2) |
| **6 诊断规则** | [MVP 开发计划 §7.2](./mvp-plan.md#72-mvp-6-条诊断规则) | P0 (2条) + P1 (4条) |
| **训练场景** | [三个训练场景](../specs/assessment-mode.md) | 3个场景: 站姿检查 / 慢动作训练 / 全速分析 |
| **产品版本** | [三种产品版本](../specs/three-product-versions.md) | Lite / Pro / Elite |

### 3.2 架构决策

| 决策 | 结果 | ADR |
|------|------|-----|
| 移动端框架 | Swift iOS 原生 | [ADR-0007](../decisions/0007-swift-ios-native.md) |
| LLM Provider | GPT-4o-mini | [架构决策](../decisions/architecture-decisions-2025-12-23.md) |
| IMU 选型 | LSM6DSV16X | [ADR-0002](../decisions/0002-lsm6dsv16x-imu.md) |
| MCU 选型 | ESP32-S3 | [ADR-0005](../decisions/0005-esp32-s3-microcontroller.md) |
| EMG 选型 | MyoWare 2.0 + Link Shield | [架构决策](../decisions/architecture-decisions-2025-12-23.md) |
| 时间同步 | Sensor Hub + Impact 对齐 | [数据管道](./data-flow.md) |
| 升级路径 | LEGO block 可替换设计 | [模块化设计](./modular-architecture.md) |

### 3.3 开发计划

| 文档 | 内容 |
|------|------|
| **[MVP 开发计划](./mvp-plan.md)** | MVP 阶段划分、验收标准、Post-MVP 路线图 |
| [移动开发指南](../../development/mobile/development.md) | Swift iOS 开发规范 |

---

## 4. 版本历史

| 版本 | 日期 | 修改内容 |
|------|------|----------|
| 1.0 | 2025-12-18 | 初始版本，整合所有详细规格 |
| 1.1 | 2025-12-23 | 增加 Sensor Hub 架构, 更新硬件选型, 澄清 BLE 时间同步策略 |
| 2.0 | 2025-12-25 | **重大重构**: 并行开发策略 (Track A/B)、Mock Data 解耦、测试金字塔、简化章节结构 |
| 2.1 | 2025-12-25 | 新增 Section 2.6 开发阶段 vs 产品阶段、Mermaid 工作流图、2025 移动端最佳实践 |
| 2.2 | 2025-12-25 | 修复 Section 1.2 架构图顺序 (改为 top-to-bottom 数据流) |
| 3.0 | 2025-12-25 | **重大变更**: Flutter → Swift 原生 iOS 开发 (见 [ADR-0007](../decisions/0007-swift-ios-native.md)) |
| 3.1 | 2025-12-25 | **重构 1.2**: 静态层级图 → 7阶段动态数据流图 (从挥杆到反馈的完整端到端流程) |
| 3.2-3.9 | 2025-12-25-27 | 多次重构优化，详见 git history |
| 4.0 | 2025-12-27 | **文档拆分**: MVP 相关内容迁移至 [mvp-plan.md](./mvp-plan.md)，本文档聚焦长期稳定架构 |

---

**最后更新**: 2025-12-27
**维护者**: Movement Chain AI Team
