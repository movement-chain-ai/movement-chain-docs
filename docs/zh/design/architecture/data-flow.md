# 数据流

> **文档状态**: 草稿 v1.2
> **最后更新**: 2025-12-23
> **关联文档**: [模块化设计](modular-architecture.md) | [三个训练场景](../specs/modes/assessment-mode.md) | [生物力学基准](../../prerequisites/foundations/biomechanics-benchmarks.md) | [关键决策 2025-12](../decisions/architecture-decisions-2025-12-23.md)

---

## 引言

### 文档目的

本文档回答 Movement Chain AI 系统的四个核心问题，帮助团队成员理解数据如何从传感器流向用户反馈。

### 核心问题导读

| 问题 | 简短回答 | 详细章节 |
|-----|---------|---------|
| 每个时间戳有什么数据? | 原始传感器数据 + 计算特征，两者都有 | [§1 数据全景图](#1-数据全景图) |
| 数据如何变成用户反馈? | 特征提取 → Kinematic Prompt → LLM 反馈 (挥杆后) | [§2 数据流详解](#2数据流详解) |
| "标准"从哪里来? | TPI + 学术论文，基于研究不是猜测 | [§3 标准与阈值来源](#3-标准与阈值来源) |
| 用户实际看到什么? | 简单界面 + 语音反馈，不是复杂图表 | [§4 用户体验设计](#4-用户体验设计) |

---

## 1. 数据全景图

数据从用户挥杆到最终反馈，经过 7 层处理。下图展示完整的端到端数据流，**每层标注输入/输出数据格式**：

```text
┌──────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                           Movement Chain AI — 数据流全景图                                             │
│                                    (含各层输入/输出数据格式)                                             │
├──────────────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                                      │
│  ╔══════════════════════════════════════════════════════════════════════════════════════════════╗    │
│  ║  STAGE 1: 用户挥杆 (User Swings)                                                              ║    │
│  ║                                                                                              ║    │
│  ║                              🏌️ 高尔夫球手挥杆                                                 ║    │
│  ║                                    │                                                         ║    │
│  ║         ┌──────────────────────────┼──────────────────────────┐                              ║    │
│  ║         │                          │                          │                              ║    │
│  ║         ▼                          ▼                          ▼                              ║    │
│  ║   📹 iPhone Camera           💪 Arm Hub                  💪 Core Hub                         ║    │
│  ║    (Vision 30fps)            (IMU+EMG)                   (IMU+EMG)                           ║    │
│  ║                                                                                              ║    │
│  ║  ─────────────────────────────────────────────────────────────────────────────────────────   ║    │
│  ║  【输出 D1】物理信号: 光信号 + 加速度/角速度 + 肌电信号                                             ║    │
│  ╚══════════════════════════════════════════════════════════════════════════════════════════════╝    │
│                                                 │                                                    │
│  ╔══════════════════════════════════════════════│════════════════════════════════════════════════╗   │
│  ║  STAGE 2: 数据采集层 (Data Collection)         ▼                                                ║   │
│  ║                                                                                               ║   │
│  ║  【输入 D1】物理信号 (光/加速度/肌电)                                                              ║   │
│  ║                                                                                               ║   │
│  ║  ┌───────────────────┐    ┌─────────────────────────┐   ┌─────────────────────────┐           ║   │
│  ║  │  📹 Vision         │   │  🔄 Arm Hub             │   │  🔄 Core Hub            │           ║   │
│  ║  │  ───────────────   │   │  ───────────────────    │   │  ───────────────────    │           ║   │
│  ║  │  MediaPipe iOS     │   │  ESP32-S3               │   │  ESP32-S3               │           ║   │
│  ║  │  30 fps            │   │  LSM6DSV16X 1666Hz      │   │  LSM6DSV16X 1666Hz      │           ║   │
│  ║  │                    │   │  MyoWare 2.0 1000Hz     │   │  MyoWare 2.0 1000Hz     │           ║   │
│  ║  └─────────┬──────────┘   └───────────┬─────────────┘   └───────────┬─────────────┘           ║   │
│  ║            │                          │                             │                         ║   │
│  ║  ─────────────────────────────────────────────────────────────────────────────────────────    ║   │
│  ║  【输出 D2】原始数据帧 (Raw Frames)                                                              ║   │
│  ║  ┌────────────────────────────────────────────────────────────────────────────────────────┐   ║   │
│  ║  │  VideoFrame (30fps):              IMUFrame (1666Hz):            EMGFrame (1000Hz):     │   ║   │
│  ║  │  {                                {                             {                      │   ║   │
│  ║  │    timestamp_ms: 100,               timestamp_us: 100000,         timestamp_us: 100000,│   ║   │
│  ║  │    image: CVPixelBuffer,            gyro_x: 12.3,    // °/s       core_mV: 0.45,       │   ║   │
│  ║  │    landmarks: [                     gyro_y: -5.1,    // °/s       forearm_mV: 0.12     │   ║   │
│  ║  │      {x:0.45, y:0.32,               gyro_z: -450.2,  // °/s     }                      │   ║   │
│  ║  │       z:-0.1, v:0.98},              accel_x: 0.2,    // m/s²                           │   ║   │
│  ║  │      ...×33 keypoints               accel_y: 9.7,    // m/s²                           │   ║   │
│  ║  │    ]                                accel_z: 0.5     // m/s²                           │   ║   │
│  ║  │  }                                }                                                    │   ║   │
│  ║  └────────────────────────────────────────────────────────────────────────────────────────┘   ║   │
│  ╚══════════════════════════════════════════════════════════════════════════════════════════════╝    │
│                                                 │                                                    │
│  ╔══════════════════════════════════════════════│════════════════════════════════════════════════╗   │
│  ║  STAGE 3: 传感器融合层 (Sensor Fusion)         ▼                                                ║   │
│  ║                                                                                               ║   │
│  ║  【输入 D2】三路异步数据流 (不同采样率、不同时钟源)                                                   ║   │
│  ║  Vision: 30fps (iOS时钟)  │  IMU: 1666Hz (ESP32时钟)  │  EMG: 1000Hz (ESP32时钟)                ║   │
│  ║                                                                                               ║   │
│  ║  ┌────────────────────────────────────────────────────────────────────────────────────────┐   ║   │
│  ║  │                               三层时间同步架构                                            │   ║   │
│  ║  │   Layer 1: 同一 ESP32 内          Layer 2: 跨 ESP32             Layer 3: Vision 对齐     │   ║   │
│  ║  │   IMU+EMG 共享时钟源             Impact 事件对齐                Impact 帧匹配到 T=0         │   ║   │
│  ║  │   精度: <10μs                    精度: 69-477μs                精度: ±16.7ms             │   ║   │
│  ║  │                                                                                        │   ║   │
│  ║  │                        统一时间轴 (IMU 为主时钟 1666Hz)                                   │   ║   │
│  ║  │   Vision 30fps   ───→  线性插值      ───→  1666Hz                                       │   ║   │
│  ║  │   EMG 1000Hz     ───→  三次样条插值  ───→  1666Hz                                        │   ║   │
│  ║  │   IMU 1666Hz     ───→  参考轴 (不变)                                                     │   ║   │
│  ║  └────────────────────────────────────────────────────────────────────────────────────────┘   ║   │
│  ║                                                                                               ║   │
│  ║  ─────────────────────────────────────────────────────────────────────────────────────────    ║   │
│  ║  【输出 D3】时间对齐帧序列 AlignedFrame[] (统一 1666Hz, 一次挥杆约 2000 帧)                          ║   │
│  ║  ┌────────────────────────────────────────────────────────────────────────────────────────┐   ║   │
│  ║  │  AlignedFrame: {                                                                       │   ║   │
│  ║  │    unified_timestamp_us: 100000,                                                       │   ║   │
│  ║  │    vision: { landmarks: [{x,y,z,v}, ...×33], interpolated: true },                     │   ║   │
│  ║  │    imu:    { gyro: {x,y,z}, accel: {x,y,z} },                                          │   ║   │
│  ║  │    emg:    { core_mV: 0.45, forearm_mV: 0.12, interpolated: true }                     │   ║   │
│  ║  │  }                                                                                     │   ║   │
│  ║  └────────────────────────────────────────────────────────────────────────────────────────┘   ║   │
│  ╚══════════════════════════════════════════════════════════════════════════════════════════════╝    │
│                                                 │                                                    │
│  ╔══════════════════════════════════════════════│════════════════════════════════════════════════╗   │
│  ║  STAGE 4: 特征提取层 (Feature Extraction)    ▼                                                  ║   │
│  ║                                                                                               ║   │
│  ║  【输入 D3】AlignedFrame[] (挥杆窗口, 约 2000 帧)                                                ║   │
│  ║                                                                                               ║   │
│  ║  ┌────────────────────────────────────────────────────────────────────────────────────────┐   ║   │
│  ║  │  ┌─────────────────────────┐   ┌─────────────────────────┐   ┌─────────────────────┐   │   ║   │
│  ║  │  │  Vision 指标 (6个)       │   │  IMU 指标 (4个)          │   │  EMG 指标 (2个)      │   │   ║   │
│  ║  │  │  • X-Factor    35-55°   │   │  • Peak Velocity >800°/s│   │  • Core Act. >50%   │   │   ║   │
│  ║  │  │  • X-Factor延展  5-15°   │   │  • Tempo Ratio 2.5-3.5  │   │  • Timing Gap >20ms │   │   ║   │
│  ║  │  │  • 转肩角      80-110°   │   │  • Backswing 0.8-1.2s   │   │    (核心先于前臂)     │   │   ║   │
│  ║  │  │  • 转髋角      35-55°    │   │  • Downswing 0.20-0.35s │   │                     │   │   ║   │
│  ║  │  │  • S-Factor    20-35°   │   │                         │   │                     │   │   ║   │
│  ║  │  │  • Sway/Lift   <5cm     │   │                         │   │                     │   │   ║   │
│  ║  │  └─────────────────────────┘   └─────────────────────────┘   └─────────────────────┘   │   ║   │
│  ║  │        WHAT: 姿态                     WHEN: 时序                     WHY: 原因           │   ║   │
│  ║  └────────────────────────────────────────────────────────────────────────────────────────┘   ║   │
│  ║                                                                                               ║   │
│  ║  ┌────────────────────────────────────────────────────────────────────────────────────────┐   ║   │
│  ║  │  8 阶段挥杆检测: Address → Takeaway → Backswing → Top → Downswing → Impact → Follow → Finish ║   │
│  ║  └────────────────────────────────────────────────────────────────────────────────────────┘   ║   │
│  ║                                                                                               ║   │
│  ║  ─────────────────────────────────────────────────────────────────────────────────────────    ║   │
│  ║  【输出 D4】SwingAnalysis (单次挥杆分析结果)                                                       ║   │
│  ║  ┌────────────────────────────────────────────────────────────────────────────────────────┐   ║   │
│  ║  │  SwingAnalysis: {                                                                      │   ║   │
│  ║  │    swing_id: "swing_20251223_143052",                                                  │   ║   │
│  ║  │    phases: { address: {start,end}, backswing: {...}, top: {...}, ... },                │   ║   │
│  ║  │    vision_metrics: { x_factor: 42.3, s_factor: 28.3, ... },                            │   ║   │
│  ║  │    imu_metrics: { peak_velocity: 892.5, tempo_ratio: 2.94, ... },                      │   ║   │
│  ║  │    emg_metrics: { core_activation_pct: 45.2, timing_gap_ms: 55 }                       │   ║   │
│  ║  │  }                                                                                     │   ║   │
│  ║  └────────────────────────────────────────────────────────────────────────────────────────┘   ║   │
│  ╚══════════════════════════════════════════════════════════════════════════════════════════════╝    │
│                                                 │                                                    │
│  ╔══════════════════════════════════════════════│════════════════════════════════════════════════╗   │
│  ║  STAGE 5: 分析诊断层 (Analysis & Diagnosis)  ▼                                                  ║   │
│  ║                                                                                               ║   │
│  ║  【输入 D4】SwingAnalysis + UserProfile + HistoricalSwings[]                                   ║   │
│  ║                                                                                               ║   │
│  ║  ┌────────────────────────────────────────────────────────────────────────────────────────┐   ║   │
│  ║  │  四种对比基准: Pro对比(TPI标准) │ Personal Best │ Statistical(DTW) │ Learned(ML)          │   ║   │
│  ║  └────────────────────────────────────────────────────────────────────────────────────────┘   ║   │
│  ║  ┌────────────────────────────────────────────────────────────────────────────────────────┐   ║   │
│  ║  │  规则引擎 (6 条诊断规则):                                                                 │   ║   │
│  ║  │  P0: ARMS_BEFORE_CORE (gap<-20ms) │ FALSE_COIL (x>=35 & core<50%)                      │   ║   │
│  ║  │  P1: LOW_X_FACTOR │ FAST_TEMPO │ SLOW_TEMPO │ EARLY_RELEASE                            │   ║   │
│  ║  └────────────────────────────────────────────────────────────────────────────────────────┘   ║   │
│  ║  ┌────────────────────────────────────────────────────────────────────────────────────────┐   ║   │
│  ║  │  ⭐ 因果归因 (核心差异化): 竞品只说 WHAT，我们说 WHAT + WHY + HOW TO FIX                     │   ║   │
│  ║  └────────────────────────────────────────────────────────────────────────────────────────┘   ║   │
│  ║                                                                                               ║   │
│  ║  ─────────────────────────────────────────────────────────────────────────────────────────    ║   │
│  ║  【输出 D5】RuleEvaluation { triggered_rules: [...], passed_rules: [...], overall_score: 78 }  ║   │
│  ╚══════════════════════════════════════════════════════════════════════════════════════════════╝    │
│                                                 │                                                    │
│  ╔══════════════════════════════════════════════│════════════════════════════════════════════════╗   │
│  ║  STAGE 6: AI 反馈生成层 (AI Feedback)          ▼                                                ║   │
│  ║                                                                                               ║   │
│  ║  【输入 D5】RuleEvaluation + SwingAnalysis + UserHistory                                        ║   │
│  ║                                                                                               ║   │
│  ║  ┌────────────────────────────────────────────────────────────────────────────────────────┐   ║   │
│  ║  │  Kinematic Prompts: 结构化数据 → LLM 可理解文本                                           │   ║   │
│  ║  │  "X-Factor: 42.3° ✅ | Core: 45.2% ⚠️ | 触发: FALSE_COIL | 历史: 10次中7次核心不足"       │   ║   │
│  ║  └────────────────────────────────────────────────────────────────────────────────────────┘   ║   │
│  ║  ┌────────────────────────────────────────────────────────────────────────────────────────┐   ║   │
│  ║  │  LLM 翻译: 预定义模板(<5ms) │ Gemini 2.5 Flash(~290ms) │ GPT-4o-mini(~300ms)             │   ║   │
│  ║  └────────────────────────────────────────────────────────────────────────────────────────┘   ║   │
│  ║                                                                                               ║   │
│  ║  ─────────────────────────────────────────────────────────────────────────────────────────    ║   │
│  ║  【输出 D6】FeedbackResult { text: "转肩够了，但核心没发力。收紧腹肌。", score: 78 }                 ║   │
│  ╚══════════════════════════════════════════════════════════════════════════════════════════════╝    │
│                                                 │                                                    │
│  ╔══════════════════════════════════════════════│════════════════════════════════════════════════╗   │
│  ║  STAGE 7: 用户反馈层 (User Feedback)           ▼                                                ║   │
│  ║                                                                                               ║   │
│  ║  【输入 D6】FeedbackResult + UserPreferences                                                   ║   │
│  ║                                                                                               ║   │
│  ║  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐           ║   │
│  ║  │ 📱 App UI       │  │ 🔊 语音 TTS      │  │ 📳 触觉反馈      │  │ 👻 Ghost 叠加   │           ║   │
│  ║  │ Score: 78       │  │ "收紧腹肌"        │  │ 振动提示         │  │ 骨架对比         │           ║   │
│  ║  │ X-Factor ✅     │  │ 1-2句话          │  │                 │  │                 │           ║   │
│  ║  │ 核心激活 ⚠️      │  │                  │  │                 │  │                 │          ║   │
│  ║  └─────────────────┘  └─────────────────┘  └─────────────────┘  └─────────────────┘           ║   │
│  ║                                                                                               ║   │
│  ║  ─────────────────────────────────────────────────────────────────────────────────────────    ║   │
│  ║  【输出 D7】UserExperience: 挥杆结束 → 反馈呈现 <500ms                                            ║   │
│  ╚══════════════════════════════════════════════════════════════════════════════════════════════╝    │
│                                                                                                      │
├──────────────────────────────────────────────────────────────────────────────────────────────────────┤

```

#### 数据编号索引

| 编号 | 数据名称 | 说明 |
|------|----------|------|
| D1 | 物理信号 | 光信号 + 加速度/角速度 + 肌电信号 |
| D2 | Raw Frames | VideoFrame (30fps) + IMUFrame (1666Hz) + EMGFrame (1000Hz) |
| D3 | AlignedFrame[] | 时间对齐帧序列 (统一 1666Hz, 约 2000 帧/挥杆) |
| D4 | SwingAnalysis | 单次挥杆分析结果 (12 指标 + 8 阶段) |
| D5 | RuleEvaluation | 规则评估结果 (6 条诊断规则) |
| D6 | FeedbackResult | AI 反馈文本 + 分数 |
| D7 | UserExperience | 最终用户体验 (UI/语音/触觉/Ghost) |

#### 数据格式转换汇总

| 转换 | 输入 | 输出 | 关键转换 |
|------|------|------|----------|
| D1→D2 | 物理信号 (光/加速度/肌电) | Raw Frames (Video/IMU/EMG) | A/D 转换 + 数字化 |
| D2→D3 | Raw Frames (异步多流) | AlignedFrame[] (同步) | 时间同步 + 插值对齐 |
| D3→D4 | AlignedFrame[] (~2000帧) | SwingAnalysis (12指标) | 特征计算 + 阶段检测 |
| D4→D5 | SwingAnalysis + Profile | RuleEvaluation (规则+评分) | 规则匹配 + 因果归因 |
| D5→D6 | RuleEvaluation + History | FeedbackResult (教练文本) | Kinematic Prompt + LLM |
| D6→D7 | FeedbackResult + Prefs | UserExperience (多模态) | TTS/UI/Haptics 渲染 |

> 📐 详见: [系统架构](./system-design.md#12-完整系统架构) — 完整的 7 层架构详解

---

## 2.数据流详解

### 2.1 D1-D2 信号采集与数字化

D1→D2 阶段将物理世界的模拟信号转换为数字化的原始数据帧：

| 传感器 | D1 (物理信号) | 处理过程 | D2 (数字帧) |
|--------|--------------|----------|-------------|
| **Vision** | 光信号 | iPhone 摄像头 → MediaPipe 检测 | VideoFrame (33 关键点 @ 30fps) |
| **IMU** | 加速度/角速度 | LSM6DSV16X A/D 转换 | IMUFrame (6 轴 @ 1666Hz) |
| **EMG** | 肌电信号 | 滤波 → 整流 → RMS 包络 | EMGFrame (2 通道 @ 1000Hz) |

> 📚 **EMG 信号处理原理**: [信号处理入门 §1-4](../../prerequisites/signal-processing-101.md) — EMG 滤波、整流、RMS 包络、Onset 检测等

#### 2.1.1 D2 数据帧格式

##### MediaPipe Vision ([30fps](../../reference/engineering-glossary.md#4-fps-每秒帧数))

每帧输出 33 个关键点，使用[归一化坐标](../../reference/software-glossary.md#7-归一化坐标-normalized-coordinates)：

```python
PoseLandmark = {
    "x": float,        # 归一化坐标 [0, 1]，0=左边缘，1=右边缘
    "y": float,        # 归一化坐标 [0, 1]，0=上边缘，1=下边缘
    "z": float,        # 相对髋部的深度，负=比髋部更靠近镜头
    "visibility": float # 可见度 [0, 1]
}

# 关键关键点索引
LANDMARKS = {
    11: "left_shoulder",
    12: "right_shoulder",
    23: "left_hip",
    24: "right_hip",
    # ... 共 33 个
}
```

##### IMU (1666Hz, 最高支持 7.68kHz)

```python
@dataclass
class IMUFrame:
    timestamp_us: int      # 微秒时间戳 - 来自 ESP32 esp_timer_get_time()
    gyro_x: float          # 角速度 X (°/s)
    gyro_y: float          # 角速度 Y (°/s)
    gyro_z: float          # 角速度 Z (°/s) ← 主要旋转轴
    accel_x: float         # 加速度 X (m/s²)
    accel_y: float         # 加速度 Y (m/s²)
    accel_z: float         # 加速度 Z (m/s²)
```

##### EMG (1000Hz)

```python
@dataclass
class EMGFrame:
    timestamp_us: int      # 微秒时间戳 - 来自 ESP32 esp_timer_get_time()
    core_mV: float         # 核心肌群电压 (mV)
    forearm_mV: float      # 前臂肌群电压 (mV)
```

---

### 2.2 D2-D3 传感器融合与时间对齐

D2→D3 阶段将三路异步数据流（不同采样率、不同时钟源）融合为统一时间轴的 AlignedFrame[]：

| 输入 (D2) | 采样率 | 时钟源 | 输出 (D3) |
|-----------|--------|--------|-----------|
| VideoFrame | 30 fps | iOS 时钟 | 线性插值 → 1666Hz |
| IMUFrame | 1666 Hz | ESP32 时钟 | 参考轴（不变） |
| EMGFrame | 1000 Hz | ESP32 时钟 | 三次样条插值 → 1666Hz |

> 📚 **时间同步原理**: [信号处理入门 §3](../../prerequisites/signal-processing-101.md#part3-sync) — 时钟对齐、插值方法、Impact 事件同步

#### 2.2.1 时间同步策略

!!! warning "BLE 时间抖动 - 关键风险 (2025-12 验证)"
    **❌ 错误方法**: 使用 iPhone 接收时间作为传感器时间戳

    - BLE 连接间隔抖动: ±15-30ms (随机)
    - 这个抖动会掩盖真实的 20-50ms 肌肉激活差异
    - Downswing 阶段仅 200-400ms,30ms 误差 = 7.5-15% 相位错误

    **✅ 正确方法**: ESP32 源端时间戳 + Sensor Hub 架构

    - 同一身体部位的 IMU + EMG 共享同一个 ESP32 时钟
    - 使用 `esp_timer_get_time()` 在采集时立即打微秒时间戳
    - 跨设备使用 Impact 事件对齐

    详见 [关键决策 2025-12](../decisions/architecture-decisions-2025-12-23.md#45-视频与传感器同步方案)

```text
IMU 是主时钟 (Master Clock):
├── Vision 30fps → 线性插值到 1666Hz
├── EMG 1000Hz  → 三次样条插值到 1666Hz
└── IMU 1666Hz  → 参考轴 (不变)

同步要求: 误差 < 10ms
```

!!! tip "实现细节"
    时间同步的具体实现方案（NTP 预同步 + Impact 验证）详见
    [模块化设计 §2.2.3](modular-architecture.md#223-时间同步实现方案)。

#### 2.2.2 Sensor Hub 时间同步架构 {#sensor-hub-架构-2025-12-推荐}

> 📐 **物理架构图**: 见 [模块化设计 §2.2.4](./modular-architecture.md#224-sensor-hub-architecture) (单一权威来源)

本节聚焦于**时间同步的 3 层级架构**，与物理布局互补：

```text
┌─────────────────────────────────────────────────────────────────┐
│                    Sensor Hub 时间同步架构 (3 层级)                │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   层级 1: Sensor Hub 内部同步 (同一 ESP32)                         │
│   ───────────────────────────────────────                       │
│   ESP32 #1 (手臂):          ESP32 #2 (核心):                     │
│     ├── IMU (I2C)              ├── IMU (I2C)                    │
│     └── EMG (ADC)              └── EMG (ADC)                    │
│   esp_timer_get_time()       esp_timer_get_time()               │
│   精度: <10 μs               精度: <10 μs                        │
│                                                                 │
│   层级 2: 跨 Sensor Hub 对齐 (Impact 事件)                        │
│   ───────────────────────────────────────                       │
│   1. 各 Sensor Hub 独立记录(带 ESP32 源时间戳)                     │
│   2. 挥杆后,使用 Impact 时刻作为 T=0 对齐                           │
│   精度: 69-477 μs (取决于 IMU ODR)                                │
│                                                                 │
│   层级 3: Vision 对齐                                            │
│   ───────────────────────────────────────                       │
│   Vision 30fps → 使用 Impact 帧对齐到传感器 T=0                    │
│   精度: ±16.7ms (30fps 帧间隔)                                    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

**同步精度总结** (权威规格):

| 场景 | 目标精度 | 实际可达 | 方法 |
|------|---------|---------|------|
| 同一 ESP32 (IMU+EMG) | <100 μs | <10 μs | esp_timer_get_time() |
| 跨 ESP32 (手臂↔核心) | <1 ms | 69-477 μs | Impact 对齐 |
| 跨设备 (ESP32↔Vision) | <10 ms | <5 ms | Impact 帧对齐 |

---

### 2.3 D3-D4 特征提取

D3→D4 阶段从统一时间轴的 AlignedFrame[] 中提取 12 项生物力学指标，输出 SwingAnalysis：

| 传感器 | 指标数量 | 作用 |
|--------|----------|------|
| **Vision** | 6 项 | WHAT: 姿态（X-Factor、S-Factor 等） |
| **IMU** | 4 项 | WHEN: 时序（Peak Velocity、Tempo 等） |
| **EMG** | 2 项 | WHY: 原因（Core Activation、Timing Gap） |

#### 2.3.1 Vision 指标 (从 MediaPipe 计算)

| 指标 | 中文名 | 公式 | 单位 | 正常范围 |
|-----|-------|------|-----|---------|
| **X-Factor** | 肩髋分离角 | `abs(shoulder_angle) - abs(hip_angle)` | 度 (°) | 35-55° |
| **S-Factor** | 肩部倾斜角 | `atan2(shoulder_height_diff, shoulder_width)` | 度 (°) | 30-40° |
| **O-Factor** | 骨盆倾斜角 | `atan2(hip_height_diff, hip_width)` | 度 (°) | 5-10° |
| **Sway** | 髋部侧移 | `hip_center.x - address_hip_center.x` | 归一化 | < 0.03 |
| **Lift** | 髋部抬升 | `hip_center.y - address_hip_center.y` | 归一化 | < 0.02 |

!!! note "为什么没有 Thrust（髋部前推）？"
    Thrust 需要测量 Z 轴（深度）位移，但 MediaPipe 的 z 坐标是从 2D 图像推断的，精度较低。
    MVP 阶段优先关注 Sway/Lift（x/y 轴精度高），Thrust 可在 Phase 2 使用双目摄像头或 LiDAR 时加入。

**X-Factor 计算示例**:

```python
def calculate_x_factor(landmarks):
    # 肩膀旋转角度
    shoulder_angle = math.atan2(
        landmarks[12].z - landmarks[11].z,  # 深度差
        landmarks[12].x - landmarks[11].x   # 水平差
    )

    # 骨盆旋转角度
    hip_angle = math.atan2(
        landmarks[24].z - landmarks[23].z,
        landmarks[24].x - landmarks[23].x
    )

    # X-Factor = 肩髋分离角
    return math.degrees(abs(shoulder_angle) - abs(hip_angle))
```

#### 2.3.2 IMU 指标

| 指标 | 中文名 | 计算方法 | 单位 | 正常范围 |
|-----|-------|---------|-----|---------|
| **Peak Velocity** | 峰值角速度 | `max(abs(gyro_z))` | °/s | > 800°/s |
| **Tempo Ratio** | 节奏比 | `backswing_time / downswing_time` | 比值 | 2.5-3.5 |
| **Top 检测** | 顶点检测 | `gyro_z` 零交叉点 (负→正) | ms | ±9-15ms 精度 |
| **Impact 检测** | 击球检测 | `gyro_z` 峰值点 | ms | ±9-15ms 精度 |

#### 2.3.3 EMG 指标

| 指标 | 中文名 | 计算方法 | 单位 | 正常范围 |
|-----|-------|---------|-----|---------|
| **Core Activation** | 核心激活度 | `RMS(core_mV) / MVC_baseline` | % | > 50% |
| **Forearm Activation** | 前臂激活度 | `RMS(forearm_mV) / MVC_baseline` | % | 40-60% |
| **Core Onset Time** | 核心激活时刻 | 信号首次超过阈值的时刻 | ms | - |
| **Forearm Onset Time** | 前臂激活时刻 | 信号首次超过阈值的时刻 | ms | - |
| **Timing Gap** | 时序差 | `forearm_onset - core_onset` | ms | > 20ms (核心先) |


!!! info "瞬时指标 vs 阶段性指标"
    指标分为两类，计算时机不同：

    **瞬时指标**：每帧/每采样点都能计算，不需要等待融合

    | 指标 | 传感器 | 说明 |
    |------|--------|------|
    | 当前帧 X-Factor 角度 | Vision | 每帧都有肩髋分离角 |
    | 当前帧 gyro_z 值 | IMU | 每个采样点都有角速度 |
    | 当前帧 EMG mV 值 | EMG | 每个采样点都有电压 |

    **阶段性指标**：需要完整挥杆窗口才能计算

    | 指标 | 计算路径 | 说明 |
    |------|----------|------|
    | X-Factor@Top | D2→D4 | 单传感器，但需先检测 Top 在哪帧 |
    | Peak Velocity | D2→D4 | 单传感器，在 IMU 序列中找最大值 |
    | Tempo Ratio | D2→D4 | 单传感器，需要阶段时长 |
    | Core Activation % | D2→D4 | 单传感器，在特定阶段计算 RMS |
    | Timing Gap | D2→D4 | 同一 ESP32 内，共享时钟 |
    | Top/Impact 检测验证 | D3→D4 | IMU + Vision 交叉验证 |

    ```text
    D2 (Raw Frames) ──────────────────────────────────────────────┐
        │                                                         │
        ├── 瞬时指标：每帧计算                                       │
        │   • Vision: 当前帧角度                                    │
        │   • IMU: 当前帧角速度                                     │
        │   • EMG: 当前帧电压                                       │
        │                                                         │
        ├── D2→D4 单传感器阶段性指标（不需要跨传感器融合）               │
        │   • Peak Velocity (IMU 序列最大值)                        │
        │   • Tempo Ratio (IMU 阶段时长)                            │
        │   • Core Activation % (EMG 阶段 RMS)                     │
        │   • Timing Gap (EMG onset 差值)                          │
        │                                                         │
        ▼ 时间对齐                                                  │
    D3 (AlignedFrame[])                                           │
        │                                                         │
        ├── D3→D4 跨传感器阶段性指标（融合后计算）                      │
        │   • Top/Impact 验证 (IMU + Vision 交叉验证)               │
        │                                                         │
        ▼ 组装                                                     │
    D4 (SwingAnalysis) ←──────────────────────────────────────────┘
    ```

### 2.4 D4-D5-D6 分析诊断与反馈生成 

#### 2.4.1 三种架构方案对比

##### 方案 A: 规则 + LLM 翻译 (保守)

```text
特征 ──→ 硬编码规则引擎 ──→ 触发的规则 ──→ LLM翻译 ──→ 用户反馈
              │
              │  IF timing_gap < -20ms:
              │      return "ARMS_BEFORE_CORE"
              │
              │  IF x_factor >= 35 AND core_activation < 50%:
              │      return "FALSE_COIL"
```

| 优点 | 缺点 |
|-----|-----|
| ✅ 100% 可预测 | ❌ 不够灵活 |
| ✅ 不会幻觉/编造 | ❌ 无法处理规则外情况 |
| ✅ 低延迟 (规则执行 <5ms) | ❌ 无法个性化 |
| ✅ 成本低 (LLM只做翻译) | ❌ 需要人工维护规则 |

##### 方案 B: [Kinematic Prompts](../../reference/ml-glossary.md#7-kinematic-prompt-运动学提示) + LLM 推理 (研究验证)

> **研究来源**: BoxingPro (2025), SportsGPT (2025) 验证了此架构

```text
计算特征 ──→ Kinematic Prompt 生成 ──→ LLM 推理 ──→ 个性化反馈
              │
              │  将结构化特征转换为 LLM 可理解的文本:
              │  "X-Factor=42° (✅ 在 35-55° 范围内)
              │   Core=45% (⚠️ 低于 50% 阈值)
              │   Timing Gap=+55ms (✅ 核心先于前臂)"
              │
              │  LLM 基于上下文推理，生成教练级反馈
```

**关键洞察**: LLM 不擅长处理原始传感器时序数据 (如 `gyro_z: [-450.2, ...]`)，但擅长基于**结构化特征**进行推理。Kinematic Prompt 是两者之间的桥梁。

| 优点 | 缺点 |
|-----|-----|
| ✅ 灵活 + 个性化 | ❌ 延迟较高 (200-500ms) |
| ✅ 不会幻觉 (输入是验证过的特征) | ❌ 需调用 LLM API |
| ✅ 可处理规则外情况 | ❌ 成本 ($5-15/月) |
| ✅ 研究验证 (BoxingPro 192-312ms) | ❌ 仅适合挥杆后反馈 |

##### 方案 C: 挥杆后分析 (推荐, MVP Phase 1)

> **对应模式**: Mode 3: Full Speed (正常挥杆后分析)

```text
┌─────────────────────────────────────────────────────────────────────┐
│              MVP Phase 1: 挥杆后分析 (Mode 3: Full Speed)             │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  Step 1: 特征提取                                                    │
│  ─────────────────                                                  │
│  • MediaPipe 骨架检测 (33关键点)                                      │
│  • Mock IMU 相位检测 + 节奏计算                                       │
│  • Mock EMG 激活计算                                                 │
│  • 6 条核心规则判断                                                   │
│                                                                     │
│  Step 2: Kinematic Prompt 生成                                       │
│  ───────────────────────────────                                    │
│  • 结构化特征 → 文本                                                  │
│  • 包含: 阶段时间线、指标、触发规则、用户历史                              │
│                                                                     │
│  Step 3: LLM 反馈生成                                                 │
│  ─────────────────────                                              │
│  • OpenAI API / Gemini 2.5 Flash                                    │
│  • 输出: 教练级反馈 + TTS 语音                                         │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘

未来扩展 (Phase 2+):
• Mode 2: Slow Motion - 慢动作实时反馈
• 历史趋势追踪、训练计划生成
```

---

#### 2.4.2 推荐架构详解 (方案 C)

**MVP Phase 1 流程** (对应 Assessment Node: FULL SPEED CHECK):

| 步骤 | 职责 | 说明 |
|-----|------|-----|
| **Step 1** | 特征提取 + 规则判断 | MediaPipe + Mock IMU/EMG → 12个指标 + 6条规则 |
| **Step 2** | Kinematic Prompt 生成 | 结构化特征 → LLM 可理解的文本 |
| **Step 3** | LLM 反馈生成 | OpenAI/Gemini → 教练级反馈 + TTS |

**关键设计原则**:

1. **挥杆后分析**: MVP Phase 1 专注 Mode 3，挥杆完成后再处理
2. **特征先行**: 先提取结构化特征，再喂给 LLM (不是原始数据)
3. **简单优先**: 实时反馈 (Mode 2) 留到 Phase 2+

**MVP 阶段实现**:

```python
# 第1步: 规则引擎判断 (硬编码, <5ms)
def evaluate_rules(features: FusionResult) -> List[Rule]:
    triggered = []

    # P0: 严重问题
    if features.emg.timing_gap < -20:
        triggered.append(Rule(
            id="ARMS_BEFORE_CORE",
            severity="P0",
            evidence=f"gap={features.emg.timing_gap}ms"
        ))

    if features.vision.x_factor >= 35 and features.emg.core_activation < 0.5:
        triggered.append(Rule(
            id="FALSE_COIL",
            severity="P0",
            evidence=f"x_factor={features.vision.x_factor}°, core={features.emg.core_activation*100}%"
        ))

    # P1: 重要问题
    if features.vision.x_factor < 35:
        triggered.append(Rule(
            id="LOW_X_FACTOR",
            severity="P1",
            evidence=f"x_factor={features.vision.x_factor}°"
        ))

    # ... 更多规则

    return triggered

# 第2步: LLM 翻译 (可选, 50-200ms)
def translate_to_feedback(rules: List[Rule]) -> str:
    if not rules:
        return "这一杆不错！"

    # 优先级排序: P0 > P1 > P2
    rules.sort(key=lambda r: r.severity)
    top_rule = rules[0]

    # 预定义模板 (快速, 无需调用 LLM)
    templates = {
        "ARMS_BEFORE_CORE": "从核心启动，让身体带动手臂",
        "FALSE_COIL": "转肩看起来够了，但核心没发力",
        "LOW_X_FACTOR": "肩膀再多转一点",
    }

    return templates.get(top_rule.id, "注意动作细节")

# 第3步 (可选): AI 个性化解释
async def generate_personalized_feedback(rules: List[Rule], user_history: UserHistory) -> str:
    prompt = f"""
    用户本次挥杆问题: {rules}
    用户历史: 最近 10 次都有类似问题

    用一句话给出个性化建议 (中文):
    """
    return await call_llm(prompt)
```

**6 条核心规则 (MVP)**:

| 规则 ID | 严重度 | 条件 | 反馈模板 |
|--------|-------|------|---------|
| `ARMS_BEFORE_CORE` | P0 | `timing_gap < -20ms` | "从核心启动" |
| `FALSE_COIL` | P0 | `x_factor >= 35 AND core < 50%` | "核心没发力" |
| `LOW_X_FACTOR` | P1 | `x_factor < 35` | "肩膀再多转" |
| `FAST_TEMPO` | P1 | `downswing < 0.20s` | "上杆慢一点" |
| `SLOW_TEMPO` | P1 | `downswing > 0.40s` | "下杆果断点" |
| `EARLY_RELEASE` | P1 | `wrist_release < 40%` | "保持手腕角度" |

---

#### 2.4.3 Kinematic Prompt 规范

Kinematic Prompt 是将计算特征转换为 LLM 可理解的结构化文本。这是让 LLM 能够进行生物力学推理的关键桥梁。

**Prompt 应包含的元素**:

| 元素 | 说明 | 示例 |
|-----|------|-----|
| **阶段时间线** | 各相位的起止时间 | Address: 0-200ms, Backswing: 200-700ms, ... |
| **关键指标** | 实测值 vs 标准范围 + 状态标记 | X-Factor: 42° (标准 35-55°) ✅ |
| **触发的规则** | Layer 1 检测到的问题 | `FALSE_COIL`, `LOW_X_FACTOR` |
| **用户历史** | 最近 N 次挥杆的重复问题 | "最近 10 次中 7 次出现核心激活不足" |
| **上下文约束** | 输出格式要求 | "用一句简洁的中文给出建议" |

**为什么不直接发送原始数据?**

```text
❌ 原始数据: gyro_z = [-12.3, -15.1, -450.2, -890.5, ...]
   → LLM 无法理解 1666Hz 时序数据的含义

✅ Kinematic Prompt: "Peak velocity = 890°/s (good, >800°/s threshold)"
   → LLM 理解这是一个达标的指标，可以进行推理
```

> **研究支持**: LLaSA (2024) 表明专门的 IMU 模型比通用 LLM 在传感器任务上好 2.6-12 倍，但通用 LLM 在**结构化特征推理**上表现良好。

---

#### 2.4.4 模型选择指南

| 用途 | 推荐模型 | 延迟 | 成本 | 备注 |
|-----|---------|------|-----|------|
| **LLM 反馈生成** | Gemini 2.5 Flash | ~290ms | $0.15/$0.60 per 1M tokens | 最佳性价比，1M 上下文 |
| **LLM 备选** | OpenAI GPT-4o | ~300ms | $2.50/$10 per 1M tokens | 当前 MVP 使用 |
| **开源替代** | Qwen3-8B | 可变 | 自托管成本 | 需自建推理服务 |
| **姿态估计** | MediaPipe | 10-30ms | 免费 | 33 关键点检测 |

**成本估算** (按每月 300 次挥杆计算):

| 方案 | 特征提取 | LLM 调用 | 总成本 |
|-----|---------|---------|-------|
| MVP (OpenAI) | $0 | ~$5-10 | **$5-10/月** |
| 优化 (Gemini Flash) | $0 | ~$2-5 | **$2-5/月** |

---

#### 2.4.5 研究来源

本架构基于以下 2024-2025 年研究:

| 研究 | 关键发现 | 链接 |
|-----|---------|------|
| **BoxingPro (2025)** | IMU + 视频 → Kinematic Prompts → LLM, 192-312ms 延迟 | MDPI Computers 14(21):4155 |
| **SportsGPT (2025)** | Qwen3-8B + RAG, 1.42ms 推理 | [arXiv](https://arxiv.org/abs/2506.05573) |
| **LLaSA (2024)** | 专用 IMU 模型比通用 LLM 好 2.6-12× | [arXiv](https://arxiv.org/abs/2406.14498) |
| **CaddieSet (CVPR 2025)** | 特征工程 + Random Forest 优于端到端深度学习 | [GitHub](https://github.com/damilab/CaddieSet) |
| **Multi-Sport Fusion (2025)** | 多模态传感器融合, 192-312ms 验证 | [Nature](https://www.nature.com/articles/s41598-025-12920-9) |

---

## 3. 标准与阈值来源 {#3-标准与阈值来源}

### 3.1 行业标准: TPI

**TPI (Titleist Performance Institute)** 是高尔夫行业的官方生物力学认证机构。

```text
┌────────────────────────────────────────────────────────────────┐
│                    TPI 机构简介                                 │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│  • 成立于 2003 年                                               │
│  • 全球 30,000+ 认证教练使用                                      │
│  • 基于对职业球员的实测数据                                        │
│  • 官网: https://www.mytpi.com                                  │
│                                                                │
├────────────────────────────────────────────────────────────────┤
│                    TPI 定义的标准                                │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│  指标              │ 业余标准      │ 职业标准                     │
│  ─────────────────┼──────────────┼────────────────             │
│  X-Factor         │ > 35°        │ 42-55°                      │
│  Shoulder Turn    │ 85-100°      │ 90-100°                     │
│  Hip Turn         │ 40-55°       │ 45-55°                      │
│  Tempo Ratio      │ 2.5-3.5      │ 3:1                         │
│                                                                │
└────────────────────────────────────────────────────────────────┘
```

---

### 3.2 学术论文

#### Meister et al. (2011)

**论文**: "Rotational Biomechanics of the Elite Golf Swing: Benchmarks for Amateurs"
**期刊**: Journal of Applied Biomechanics, Vol. 27(3), pp. 242-251

**定义的标准**:

| 指标 | 职业球员平均值 | 来源 |
|-----|--------------|------|
| 骨盆旋转速度 | 477°/s ± 53°/s | 表 2 |
| 躯干旋转速度 | 552°/s ± 48°/s | 表 2 |
| S-Factor (肩部倾斜) | 30-40° | 图 4 |

**论文链接**: [PDF](https://waddengolfacademy.com/biomechanics/Rotational%20Biomechanics%20Meister%20Ladd.pdf)

#### Cheetham et al. (2008)

**论文**: "Comparison of Kinematic Sequence Parameters in the Golf Swings of High and Low Handicap Golfers"

**定义的标准**:

| 指标 | 描述 | 职业标准 |
|-----|------|---------|
| 运动链顺序 | 骨盆 → 躯干 → 手臂 → 球杆 | 正确顺序 |
| 核心→前臂时间差 | Core onset 早于 Forearm onset | 30-60ms |

**关键发现**: 职业球员的核心肌群比前臂早激活 30-60ms，业余球员往往相反或同时。

#### PMC Systematic Review (2022)

**论文**: PMC Systematic Review on Golf Biomechanics (92 篇论文 meta-analysis)
**链接**: [PMC9227529](https://pmc.ncbi.nlm.nih.gov/articles/PMC9227529/)

**综合定义**:

- 12 项核心指标的标准值
- 性别调整因子 (女性 X-Factor 平均低 11%)
- 年龄调整因子

---

### 3.3 标准如何应用

**从研究到规则的转化过程**:

```text
学术论文
    │
    │  Cheetham et al. (2008):
    │  "职业球员核心比前臂早激活 30-60ms"
    │
    ▼
阈值定义
    │
    │  正常: gap > 20ms (核心先)
    │  问题: gap < -20ms (前臂先)
    │
    ▼
规则编码
    │
    │  if timing_gap < -20:
    │      return "ARMS_BEFORE_CORE"
    │
    ▼
用户反馈
    │
    │  "从核心启动，让身体带动手臂"
```

**为什么 AI 不会"说错话"?**

```text
┌────────────────────────────────────────────────────────────────┐
│                    判断与翻译分离                                │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│  判断层 (规则引擎):                                              │
│  ───────────────────                                           │
│  • 基于研究论文的固定阈值                                          │
│  • IF-THEN 逻辑，100% 可预测                                     │
│  • 不会"猜测"或"编造"                                            │
│                                                                │
│  翻译层 (LLM):                                                  │
│  ───────────────────                                           │
│  • 只负责把规则结果翻译成人话                                      │
│  • 输入是结构化的规则 ID，不是原始数据                              │
│  • 即使翻译略有不同，意思不会错                                     │
│                                                                │
│  结论: AI 不做判断，只做翻译。判断由固定规则完成。                     │
│                                                                │
└────────────────────────────────────────────────────────────────┘
```

---

## 4. 用户体验设计 {#4-用户体验设计}

### 4.1 用户界面

用户在手机 App 上看到的界面简洁明了:

```text
┌────────────────────────────────────────────────────────────────┐
│              用户手机界面                                        │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  FPS: 30  │  Score: 78  │  🔋 85%                        │  │
│  ├──────────────────────────────────────────────────────────┤  │
│  │                                                          │  │
│  │                                                          │  │
│  │           ┌─────────────────────────────────┐            │  │
│  │           │                                 │            │  │
│  │           │      [实时摄像头画面]             │            │  │
│  │           │                                 │            │  │
│  │           │         👤                      │            │  │
│  │           │        /│\   ← 半透明骨架         │            │  │
│  │           │        / \     (白色, 覆盖在身体上)             │  │
│  │           │                                 │            │  │
│  │           │      ↓ 红色箭头                  │            │  │
│  │           │      (指向需要调整的关节)          │            │  │
│  │           │                                 │            │  │
│  │           └─────────────────────────────────┘            │  │
│  │                                                          │  │
│  ├──────────────────────────────────────────────────────────┤  │
│  │                                                          │  │
│  │   X-Factor: 42° ✅    核心激活: 弱 ⚠️                      │  │
│  │                                                          │  │
│  │   [开始录制]  [设置]  [历史]                                │  │
│  │                                                          │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                │
├────────────────────────────────────────────────────────────────┤
│                    设计原则                                     │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│  1. 简洁: 不超过 3 个关键指标                                     │
│  2. 聚焦: 每次只指出 1-2 个问题                                   │
│  3. 不干扰: 覆盖层半透明，不遮挡身体                                │
│  4. 可操作: 反馈告诉用户"怎么做"，不是"什么错"                       │
│                                                                │
└────────────────────────────────────────────────────────────────┘
```

**颜色编码**:

| 颜色 | 含义 | 示例 |
|-----|------|-----|
| 🟢 绿色 | 良好 | X-Factor: 45° ✅ |
| 🟡 黄色 | 需注意 | 核心激活: 弱 ⚠️ |
| 🔴 红色 | 问题 | 发力顺序: 错 ❌ |

---

### 4.2 语音反馈

**预录音频 (快速响应)**:

| 规则 | 语音内容 | 时长 |
|-----|---------|-----|
| `ARMS_BEFORE_CORE` | "从核心启动" | ~1s |
| `FALSE_COIL` | "核心没发力" | ~1s |
| `LOW_X_FACTOR` | "肩膀再多转一点" | ~1.2s |
| `FAST_TEMPO` | "上杆慢一点" | ~1s |
| `GOOD_SWING` | "这一杆不错！" | ~1s |

**动态 TTS (需要具体数值时)**:

```text
"X因子 32 度，不够"
"速度 1200，很不错"
"这一杆 85 分"
```

**优先级系统**:

```text
P0 (最先说): 严重问题 (ARMS_BEFORE_CORE, FALSE_COIL)
P1 (其次):   重要问题 (LOW_X_FACTOR, TEMPO)
P2 (最后):   优化建议 (BALANCE)

规则: 每次最多说 2 条反馈，避免信息过载
```

---

### 4.3 Rerun 开发者可视化

Rerun 是**开发者调试工具**，用于验证多流数据是否正确对齐。

```text
┌────────────────────────────────────────────────────────────────┐
│              Rerun 时间轴可视化 (开发者视角)                       │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│  时间轴 (ms):  0    200   400   600   800   1000  1200          │
│  ───────────────────────────────────────────────────────────── │
│                                                                │
│  📷 Video:     ●────●────●────●────●────●────●────●            │
│                     (每 33ms 一帧)                              │
│                                                                │
│  🔄 gyro_z:    ─────────────────●─────────●─────────           │
│                              (Top)     (Impact)                │
│                           零交叉点     峰值点                    │
│                                                                │
│  💪 Core EMG:  ─────────────────●──────────────────            │
│                              (激活)                             │
│                              485ms                             │
│                                                                │
│  💪 Forearm:   ───────────────────────●────────────            │
│                                     (激活)                      │
│                                     540ms                      │
│                                                                │
│  ───────────────────────────────────────────────────────────── │
│                                                                │
│  验证点:                                                        │
│  ✅ Top (零交叉) 对齐 Video 帧中手臂最高点                         │
│  ✅ Impact (峰值) 对齐 Video 帧中击球瞬间                         │
│  ✅ Core EMG 在 Top 之前激活 (485ms < Top)                       │
│  ✅ Core 在 Forearm 之前激活 (485ms < 540ms = +55ms gap)         │
│                                                                │
└────────────────────────────────────────────────────────────────┘
```

[Rerun](https://rerun.io/) 是多模态数据调试工具，用于验证传感器融合和时间对齐。

**Rerun vs 用户界面**

| 方面 | 用户界面 (App) | 开发者工具 (Rerun) |
|-----|---------------|-------------------|
| **目的** | 帮助用户改进挥杆 | 调试和验证算法 |
| **复杂度** | 简单 (1-3 个指标) | 复杂 (多流时间轴) |
| **数据展示** | 文字 + 颜色编码 | 波形图 + 多流同步 |
| **实时性** | 实时反馈 | 离线分析 |
| **用户** | 高尔夫球手 | 工程师 |

**为什么用户不看 Rerun?**

1. **太复杂**: 普通用户不理解 EMG 波形图
2. **不可操作**: 知道"核心激活 485ms"不知道怎么改
3. **干扰练习**: 分析数据会打断挥杆节奏
4. **不需要**: 用户需要的是"怎么改"，不是"数据是什么"

**用户需要的反馈**:

```text
❌ "你的核心肌群在 485ms 时激活，前臂在 540ms 时激活，
    时间差为 +55ms，符合 Cheetham et al. (2008) 的标准"

✅ "这一杆不错！核心发力到位了"

!!! warning "重要区分"
    Rerun 是**开发者工具**，用于调试和验证算法。
    用户的手机 App 不会显示这些复杂图表。
    用户体验设计见 [§4 用户体验设计](#4-用户体验设计)。

```

#### 4.3.1 快速开始

```bash
# 安装
pip install rerun-sdk

# 验证 MediaPipe 姿态可视化 (官方示例)
python -m rerun_demos.human_pose_tracking

# 在你的代码中使用
import rerun as rr
rr.init("movement-chain", spawn=True)
rr.log("video/frame", rr.Image(frame))
rr.log("imu/gyro_z", rr.Scalar(gyro_z))
rr.log("emg/core", rr.Scalar(core_activation))
```

#### 4.3.2 调试场景速查表

| 场景 | 相关章节 | Rerun 功能 | 解决的问题 |
|------|---------|-----------|-----------|
| **时间同步验证** | §1.2 原始传感器数据 | 时间轴视图 + 多通道对齐 | 验证 Vision/IMU/EMG 是否 <10ms 对齐 |
| **MediaPipe 骨架** | §1.3 计算特征 | 官方 human_pose_tracking | 验证 33 关键点检测和特征计算 |
| **IMU 曲线分析** | §1.3 IMU 指标 | 峰值/零交叉自动检测 | 验证模拟/真实 IMU 数据质量 |
| **EMG 激活时序** | §1.3 EMG 指标 | 双曲线叠加 + onset 标记 | 验证 Core 是否先于 Forearm 激活 |
| **诊断规则调试** | §2.3 推荐架构 | 标记触发点 + 回归测试 | 验证 ARMS_BEFORE_CORE 等规则逻辑 |

#### 4.3.3 开发阶段使用建议

```text
Phase 1 (Week 1-2): Vision Pipeline
├── 必须: 验证 MediaPipe 骨架叠加
├── 必须: 验证 X-Factor 等特征计算
└── 建议: 建立第一批 .rrd 测试用例

Phase 2 (Week 3): Mock Sensor
├── 必须: 可视化 IMU/EMG 模拟数据与视频对齐
└── 必须: 验证时间同步 <10ms

Phase 3 (Week 4): Rule Engine
├── 必须: 调优规则阈值
├── 必须: 录制"正确"和"错误"挥杆对比
└── 建议: 保存问题场景 .rrd 文件

Phase 4+ (Week 5-8): Integration & Testing
├── 推荐: 验证移动端 vs 桌面端检测一致性
└── 推荐: 分享 .rrd 给团队成员协作调试
```

#### 4.3.4 详细评估

关于 Rerun 的完整技术评估、竞品对比，详见:

- **[可视化工具评估](../decisions/visualization-tools-evaluation.md)** — 为什么选择 Rerun 而非 Foxglove/PlotJuggler
- **[MVP 开发计划 §10](./mvp-plan.md#10-post-mvp-路线图)** — 项目整体技术路线图

---

## 相关文档

- [模块化设计](modular-architecture.md) - 系统模块详细设计
- [三个训练场景](../specs/modes/assessment-mode.md) - 反馈时延和通道详解
- [生物力学基准](../../prerequisites/foundations/biomechanics-benchmarks.md) - 完整阈值表
- [数据处理与指标计算](./sensor-data-processing.md) - 数据计算公式

---


文档版本: v1.3 | 作者: Movement Chain AI Team | 最后更新: 2025-12-27
