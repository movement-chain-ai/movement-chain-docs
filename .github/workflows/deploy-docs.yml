name: Deploy MkDocs to GitHub Pages

on:
  push:
    branches:
      - main
    paths:
      - 'docs/**'
      - 'mkdocs.yml'
      - '.github/workflows/deploy-docs.yml'
  workflow_dispatch:  # Allow manual triggering

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow one concurrent deployment
concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for git info plugin

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'  # Enable pip caching

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Verify MkDocs configuration
        run: |
          mkdocs --version
          python -c "import material; print(f'Material theme version: {material.__version__}')"

      - name: Build MkDocs site
        run: mkdocs build --strict --verbose

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./site

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  smoke-tests:
    needs: deploy
    runs-on: ubuntu-latest
    steps:
      - name: Wait for deployment propagation
        run: |
          echo "â³ Waiting 15 seconds for CDN propagation..."
          sleep 15

      - name: Test Landing Page
        id: test-landing
        run: |
          URL="https://movement-chain-ai.github.io/movement-chain-docs/"
          echo "Testing: $URL"
          STATUS=$(curl -f -s -o /dev/null -w "%{http_code}" "$URL")
          if [ "$STATUS" != "200" ]; then
            echo "âŒ Landing page failed with status: $STATUS"
            exit 1
          fi
          echo "âœ… Landing page: $STATUS"
          echo "status=$STATUS" >> $GITHUB_OUTPUT

      - name: Test Architecture Overview
        id: test-arch
        run: |
          URL="https://movement-chain-ai.github.io/movement-chain-docs/architecture/hld/01-system-overview/"
          echo "Testing: $URL"
          STATUS=$(curl -f -s -o /dev/null -w "%{http_code}" "$URL")
          if [ "$STATUS" != "200" ]; then
            echo "âŒ Architecture overview failed with status: $STATUS"
            exit 1
          fi
          echo "âœ… Architecture overview: $STATUS"
          echo "status=$STATUS" >> $GITHUB_OUTPUT

      - name: Test ADR-0001
        id: test-adr-0001
        run: |
          URL="https://movement-chain-ai.github.io/movement-chain-docs/decisions/0001-multi-repo-structure/"
          echo "Testing: $URL"
          STATUS=$(curl -f -s -o /dev/null -w "%{http_code}" "$URL")
          if [ "$STATUS" != "200" ]; then
            echo "âŒ ADR-0001 failed with status: $STATUS"
            exit 1
          fi
          echo "âœ… ADR-0001: $STATUS"
          echo "status=$STATUS" >> $GITHUB_OUTPUT

      - name: Test ADR-0004
        id: test-adr-0004
        run: |
          URL="https://movement-chain-ai.github.io/movement-chain-docs/decisions/0004-simplified-4-module-architecture/"
          echo "Testing: $URL"
          STATUS=$(curl -f -s -o /dev/null -w "%{http_code}" "$URL")
          if [ "$STATUS" != "200" ]; then
            echo "âŒ ADR-0004 failed with status: $STATUS"
            exit 1
          fi
          echo "âœ… ADR-0004: $STATUS"
          echo "status=$STATUS" >> $GITHUB_OUTPUT

      - name: Test Resources Index
        id: test-resources
        run: |
          URL="https://movement-chain-ai.github.io/movement-chain-docs/resources/"
          echo "Testing: $URL"
          STATUS=$(curl -f -s -o /dev/null -w "%{http_code}" "$URL")
          if [ "$STATUS" != "200" ]; then
            echo "âŒ Resources index failed with status: $STATUS"
            exit 1
          fi
          echo "âœ… Resources index: $STATUS"
          echo "status=$STATUS" >> $GITHUB_OUTPUT

      - name: Test Sitemap
        id: test-sitemap
        run: |
          URL="https://movement-chain-ai.github.io/movement-chain-docs/sitemap.xml"
          echo "Testing: $URL"
          STATUS=$(curl -f -s -o /dev/null -w "%{http_code}" "$URL")
          if [ "$STATUS" != "200" ]; then
            echo "âŒ Sitemap failed with status: $STATUS"
            exit 1
          fi
          echo "âœ… Sitemap: $STATUS"
          echo "status=$STATUS" >> $GITHUB_OUTPUT

      - name: Test Search Index
        id: test-search
        run: |
          URL="https://movement-chain-ai.github.io/movement-chain-docs/search/search_index.json"
          echo "Testing: $URL"
          STATUS=$(curl -f -s -o /dev/null -w "%{http_code}" "$URL")
          if [ "$STATUS" != "200" ]; then
            echo "âŒ Search index failed with status: $STATUS"
            exit 1
          fi
          echo "âœ… Search index: $STATUS"
          echo "status=$STATUS" >> $GITHUB_OUTPUT

      - name: Test 404 Page
        id: test-404
        run: |
          URL="https://movement-chain-ai.github.io/movement-chain-docs/this-page-does-not-exist/"
          echo "Testing: $URL"
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$URL")
          if [ "$STATUS" != "404" ]; then
            echo "âš ï¸ 404 page returned unexpected status: $STATUS (expected 404)"
            # Don't fail on this - it's informational
          else
            echo "âœ… 404 page: $STATUS"
          fi
          echo "status=$STATUS" >> $GITHUB_OUTPUT

      - name: Create Test Summary
        if: always()
        run: |
          echo "## Smoke Test Results ðŸ§ª" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deployment URL:** https://movement-chain-ai.github.io/movement-chain-docs/" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Page | Status | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Landing Page | ${{ steps.test-landing.outputs.status || 'N/A' }} | ${{ steps.test-landing.outcome == 'success' && 'âœ… Pass' || 'âŒ Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Architecture Overview | ${{ steps.test-arch.outputs.status || 'N/A' }} | ${{ steps.test-arch.outcome == 'success' && 'âœ… Pass' || 'âŒ Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ADR-0001 | ${{ steps.test-adr-0001.outputs.status || 'N/A' }} | ${{ steps.test-adr-0001.outcome == 'success' && 'âœ… Pass' || 'âŒ Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ADR-0004 | ${{ steps.test-adr-0004.outputs.status || 'N/A' }} | ${{ steps.test-adr-0004.outcome == 'success' && 'âœ… Pass' || 'âŒ Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Resources Index | ${{ steps.test-resources.outputs.status || 'N/A' }} | ${{ steps.test-resources.outcome == 'success' && 'âœ… Pass' || 'âŒ Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Sitemap.xml | ${{ steps.test-sitemap.outputs.status || 'N/A' }} | ${{ steps.test-sitemap.outcome == 'success' && 'âœ… Pass' || 'âŒ Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Search Index | ${{ steps.test-search.outputs.status || 'N/A' }} | ${{ steps.test-search.outcome == 'success' && 'âœ… Pass' || 'âŒ Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 404 Page | ${{ steps.test-404.outputs.status || 'N/A' }} | ${{ steps.test-404.outcome == 'success' && 'âœ… Pass' || 'â„¹ï¸ Info' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Total Pages Tested:** 8" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check if any critical tests failed
          if [ "${{ steps.test-landing.outcome }}" != "success" ] || \
             [ "${{ steps.test-arch.outcome }}" != "success" ] || \
             [ "${{ steps.test-adr-0001.outcome }}" != "success" ] || \
             [ "${{ steps.test-adr-0004.outcome }}" != "success" ] || \
             [ "${{ steps.test-resources.outcome }}" != "success" ] || \
             [ "${{ steps.test-sitemap.outcome }}" != "success" ] || \
             [ "${{ steps.test-search.outcome }}" != "success" ]; then
            echo "### âš ï¸ Some tests failed!" >> $GITHUB_STEP_SUMMARY
            echo "Please review the failed tests above and investigate deployment issues." >> $GITHUB_STEP_SUMMARY
          else
            echo "### âœ… All smoke tests passed!" >> $GITHUB_STEP_SUMMARY
            echo "The documentation site is live and all critical pages are accessible." >> $GITHUB_STEP_SUMMARY
          fi
