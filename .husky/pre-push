#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "üöÄ Running pre-push checks (this may take a moment)..."
echo ""

# Check if mkdocs is installed
if ! command -v mkdocs &> /dev/null; then
  echo "‚ö†Ô∏è  MkDocs not found, skipping build check"
  echo "   Install with: pip install mkdocs mkdocs-material"
else
  # Build documentation with strict mode
  echo "üèóÔ∏è  Building documentation with strict mode..."
  mkdocs build --strict --quiet

  if [ $? -ne 0 ]; then
    echo ""
    echo "‚ùå Documentation build failed!"
    echo "   Fix the errors above before pushing."
    echo ""
    exit 1
  fi

  echo "‚úÖ Documentation builds successfully"
fi

echo ""
echo "üîó Running comprehensive link check on all documentation..."

# Check if markdown-link-check is available
if command -v markdown-link-check &> /dev/null; then
  # Find all markdown files in docs directory
  MARKDOWN_FILES=$(find docs -name "*.md" 2>/dev/null || echo "")

  if [ -n "$MARKDOWN_FILES" ]; then
    LINK_ERRORS=0

    for file in $MARKDOWN_FILES; do
      echo "   Checking: $file"
      markdown-link-check "$file" --quiet 2>&1 | grep -E "(ERROR|‚úñ)" && LINK_ERRORS=$((LINK_ERRORS + 1)) || true
    done

    if [ $LINK_ERRORS -gt 0 ]; then
      echo ""
      echo "‚ö†Ô∏è  Found broken links in $LINK_ERRORS file(s)"
      echo "   This is a warning - you can still push, but please fix broken links"
      echo ""
    else
      echo "‚úÖ All links are valid"
    fi
  fi
else
  echo "‚ö†Ô∏è  markdown-link-check not found, skipping link validation"
  echo "   Install with: npm install"
fi

echo ""
echo "‚úÖ Pre-push checks completed!"
echo "üì§ Proceeding with push..."
